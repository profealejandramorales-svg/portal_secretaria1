<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Citaciones a Apoderados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .main-wrapper { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .card {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;
        }

        /* --- ESTILOS DE IMPRESI√ìN (COLILLA DE CITACI√ìN) --- */
        @media print {
            @page { size: Letter portrait; margin: 0.5cm; }
            
            body > *:not(#printable-area) { display: none !important; }

            #printable-area {
                display: block !important; 
                visibility: visible !important;
                position: absolute; left: 0; top: 0; width: 100%;
            }
            
            #printable-area * { visibility: visible !important; }
            
            /* Dise√±o de la Colilla (3 por hoja aprox) */
            .citation-slip {
                border: 2px solid #000;
                padding: 15px;
                margin-bottom: 1.5cm; /* Espacio para corte */
                background: white;
                break-inside: avoid;
                page-break-inside: avoid;
                display: flex;
                flex-direction: row;
                height: 8cm; /* Altura fija para uniformidad */
            }

            .slip-left { width: 70%; padding-right: 15px; border-right: 1px dashed #ccc; }
            .slip-right { width: 30%; padding-left: 15px; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }

            .no-print, #message-box { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="message-box" class="fixed top-5 right-5 bg-purple-600 text-white px-6 py-3 rounded shadow-lg hidden transition-opacity z-50"></div>

    <div class="main-wrapper">
        
        <div class="flex items-center justify-between mb-8 border-b pb-4 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" class="h-16 w-auto object-contain bg-gray-50 rounded-full p-1 border" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Citaci√≥n de Apoderados</h1>
                    <p class="text-xs text-gray-500 font-medium">Escuela Agr√≠cola Sagrados Corazones</p>
                </div>
            </div>
            <div class="text-right">
                <div class="flex gap-2">
                    <button class="bg-red-100 text-red-700 px-4 py-2 rounded font-bold hover:bg-red-200 text-sm transition" id="clear-data-btn">Limpiar Local</button>
                    <button class="bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700 text-sm transition" id="print-report-btn">Reporte Diario</button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 font-mono text-right">Desarrollado por ProfeAle</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="card border-t-4 border-purple-500">
                <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Nueva Citaci√≥n</h2>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Curso</label>
                        <select id="course-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none bg-gray-50">
                            <option value="">Selecciona un curso</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estudiante</label>
                        <select id="student-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none bg-gray-50" disabled>
                            <option value="">Primero selecciona un curso</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha Citaci√≥n</label>
                            <input type="date" id="citation-date" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hora</label>
                            <input type="time" id="citation-time" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Motivo</label>
                        <select id="reason-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none bg-white">
                            <option value="Rendimiento Acad√©mico">Rendimiento Acad√©mico</option>
                            <option value="Conducta / Disciplina">Conducta / Disciplina</option>
                            <option value="Convivencia Escolar">Convivencia Escolar</option>
                            <option value="Asistencia / Atrasos">Asistencia / Atrasos</option>
                            <option value="Entrevista Regular">Entrevista Regular</option>
                            <option value="Salud">Salud / Enfermer√≠a</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Modalidad</label>
                            <select id="mode-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none">
                                <option value="Presencial">Presencial</option>
                                <option value="Telef√≥nica">Telef√≥nica</option>
                                <option value="Videollamada">Videollamada</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Solicita / Cita</label>
                            <select id="teacher-input" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none bg-white">
                                <option value="">-- Seleccionar --</option>
                                <option value="Profesor Jefe">Profesor Jefe</option>
                                <option value="Equipo PIE">Equipo PIE</option>
                                <option value="Inspector√≠a General">Inspector√≠a General</option>
                                <option value="UTP">UTP</option>
                                <option value="Director">Director</option>
                                <option value="Psic√≥loga">Psic√≥loga</option>
                                <option value="Profesor Tutor">Profesor Tutor</option>
                                <option value="Otro / Prof. Asignatura">Otro / Prof. Asignatura</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Observaciones (Opcional)</label>
                        <textarea id="obs-input" rows="2" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-200 outline-none text-sm" placeholder="Traer libreta, informes, etc."></textarea>
                    </div>

                    <button id="add-to-print-list-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded shadow transition transform active:scale-95 mt-2">
                        Generar Citaci√≥n
                    </button>
                </div>

                <div id="print-list-container" class="mt-6 pt-4 border-t border-dashed hidden">
                    <div class="flex justify-between items-center mb-2 bg-yellow-50 p-2 rounded">
                        <h3 class="font-bold text-yellow-800 text-sm">üñ®Ô∏è Citaciones por Imprimir</h3>
                        <button id="clear-print-list-btn" class="text-xs text-red-500 font-bold hover:underline">Vaciar Cola</button>
                    </div>
                    <ul id="print-list" class="space-y-1 mb-4 text-sm max-h-40 overflow-y-auto"></ul>
                    <button id="print-collective-btn" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>
                        Imprimir Citaciones
                    </button>
                </div>
            </div>

            <div class="card border-t-4 border-gray-500 flex flex-col h-full">
                <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-2">Historial de Citaciones</h2>
                <div class="flex-1 overflow-y-auto max-h-[500px] pr-2">
                    <p id="report-placeholder" class="text-gray-400 italic text-center mt-10 text-sm">Cargando registros...</p>
                    <table class="w-full text-left text-sm hidden" id="report-table">
                        <thead class="bg-gray-50 sticky top-0 z-10 text-xs uppercase text-gray-500">
                            <tr>
                                <th class="p-2">Fecha Cita</th>
                                <th class="p-2">Estudiante</th>
                                <th class="p-2">Motivo</th>
                                <th class="p-2 text-right"></th>
                            </tr>
                        </thead>
                        <tbody id="report-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="printable-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuraci√≥n de Firebase (No modificar)
        const firebaseConfig = { apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I", authDomain: "suspenciones-40d0c.firebaseapp.com", projectId: "suspenciones-40d0c", storageBucket: "suspenciones-40d0c.firebasestorage.app", messagingSenderId: "853418739042", appId: "1:853418739042:web:d051befb99cd2acdd4583b" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const COLLECTION_NAME = "citaciones";

        // --- N√ìMINA DE ALUMNOS 2026 CORREGIDA Y COMPLETA ---
        const schoolData = {
            'Primero Medio A': [
                "√ÅLVAREZ FA√öNDEZ MATEO VICENTE", "CASTILLO ARAVENA MAITE PASCAL", "COLLADO PUENTES SANTINO ALEXANDER", 
                "CONCHA TORREALBA JOAQU√çN IGNACIO", "D√çAZ MALUENDA ESTEFAN√çA ANTONIA", "DONAIRE ROJAS MAITE EMILIA ESTER", 
                "ESPINOZA CACHA√ëA LISBET ALEXANDRA", "FERRADA ALBORNOZ AGUST√çN ALEXIS", "FUENTEMAVIDA BARROS OSCAR ANTONIO", 
                "JAQUE PACHECO DAMI√ÅN IGNACIO", "JARAMILLO VILLAR MATT HOST", "L√ìPEZ ACU√ëA MARCO EMILIO", 
                "L√ìPEZ VILLAR FRANCO IGNACIO", "MESA D√çAZ GONZALO IGNACIO", "MEZA CARRASCO CRISTIAN ALFONSO", 
                "MORALES GARRIDO NICOL√ÅS ANTONIO", "ORTEGA DA SILVA EMILIA CATALINA SOPHIA", "PEREIRA TAPIA KEVIN RUB√âN", 
                "RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS", "RAM√çREZ VALD√âS MARTINA POLETTE", "RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO", 
                "RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR", "ROJAS √ìRDENES TRACY MAIDEN", "S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS", 
                "SOLIZ OLGUIN BRAYAN", "VALENZUELA MU√ëOZ MAGDALENA BEL√âN"
            ],
            'Segundo Medio A': [
                "ALBURQUENQUE DEL GRECCO EMILYA ANTONIA", "ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS", "ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS", 
                "ARAYA DOM√çNGUEZ ALEX FABI√ÅN", "ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO", "ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN", 
                "BAEZ DONOSO LUKAS ALFONSO", "CARO BUSTOS KRISCHNA ESTEFANIA", "CONTRERAS SALGADO HADEEY ALEJANDRA", 
                "CUMINAO VIDAL CATALINA ANDREA", "D√çAZ MALUENDA MIGUEL ALBERTO", "IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA", 
                "KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL", "LAGOS LASTRA ALEXANDRA DANAE", "L√ìPEZ L√ìPEZ LUCIANO ANTONIO", 
                "L√ìPEZ NOVOA EYDAN DAMI√ÅN", "MALDONADO FLORES ANTONELLA BEL√âN", "MONTECINO D√çAZ VALESKA BEL√âN", 
                "MOYA REYES MATEO ANTONIO BENJAM√çN", "MU√ëOZ CONTRERAS LUIS GABRIEL", "MU√ëOZ LUNA ROGER JOEL", 
                "NAVARRO VILLANUEVA KARLA PAZ", "ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS", "OSES CAMPOS VALENTINA ABIGAIL", 
                "PALMA ORELLANA ANTONELLA FRANCISCA", "PEREIRA ORELLANA MONSERRAT ALAMIRA", "P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA", 
                "P√âREZ QUEVEDO CONSTANZA TRINIDAD", "QUEZADA NARANJO FELIPE ALONSO", "RAM√çREZ VILLALOBOS DUVAN EMILIO", 
                "RIQUELME SANTOS BENJAM√çN ALONSO", "ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD", "ROJAS LEIVA EDUARDO JAVIER", 
                "SALAZAR SALAS PEDRO JOS√â", "SANTANDER L√ìPEZ MAR√çA JOS√â", "TAPIA CASTILLA JEANFRANCO PATRICK", 
                "URBINA C√ÅCERES FRANCHESCA POULETTE", "VARGAS MORAGA MARTINA SAYEN", "V√ÅSQUEZ AGUILERA SCARLET NICOLE", 
                "V√ÅSQUEZ ZALDUENDO AMANDA ISABEL", "VERA BRAVO FLORENCIA ANTONIA", "Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN", 
                "ZABALAGA COFR√â DAMI√ÅN ANDR√âS"
            ],
            'Tercero Medio A': [
                "AHUMADA ROJAS TRINIDAD BEL√âN", "CORNEJO CASTILLO OSCAR GABRIEL", "ESPINOZA PE√ëALILLO BRAYAN JES√öS", 
                "FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO", "JARAMILLO VILLAR EMILIO SCOTT", "L√ìPEZ VILLAR MART√çN ALONSO", 
                "MEZA COLIM√ÅN ANGEL BLAS", "MIRANDA MU√ëOZ ALEXANDRA JAVIERA", "MORAGA PACHECO RENATO IGNACIO", 
                "MORALES REIM√ÅN ALFONSO TOM√ÅS", "ORELLANA GARRIDO MAT√çAS LEANDRO", "PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO", 
                "PINTO TOBAR JORD√ÅN AMARO", "RECABAL Y√Å√ëEZ KEVIN ANDR√âS", "SANDOVAL CERPA VICENTE ESTEBAN", 
                "SOTO NARANJO CHRISTOPHER", "VEKARIC VERDEJO MART√çN", "VIELMA ZABALAGA JOAN MANUEL"
            ],
            'Tercero Medio C': [
                "BRAVO MENARES ALEX JOHAN", "CARRASCO LEIVA BENJAM√çN IGNACIO", "ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER", 
                "ESPINOSA TORRES FERNANDA ELENA", "GONZ√ÅLEZ SALAZAR EMILIA CATALINA", "MEDEL OJEDA LE√ìN IGNACIO", 
                "OLIVARES VALENZUELA ALONSO IGNACIO", "OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA", "PUNOY MEDEL MILLARAY ANG√âLICA", 
                "QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO", "RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO", "RIQUELME COLOMA DALIA CONSTANZA", 
                "RIVERA ABARZA CONSTANZA VICTORIA", "SAAVEDRA BRAVO FLORENCIA ALEJANDRA", "SALGADO ROJAS VICENTE MOIS√âS", 
                "SANTIS CASSEUS TEIVA SCARLETT", "SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN", "TOLEDO ALBORNOZ ANTONELLA INES", 
                "VENEGAS ARRIAGADA ANTONIA EDITH"
            ],
            'Cuarto Medio A': [
                "ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA", "BAHAMONDE MU√ëOZ ARIEL LEON", "CAMPOS MU√ëOZ CRISTOPHER JES√öS", 
                "CANCINO OR√ìSTICA VICENTE GASPAR", "CARO URRUTIA CONSUELO ANTONIA", "CARRASCO GONZ√ÅLEZ CAMILA ANDREA", 
                "COFR√â CASTILLO ANTONIO ANDR√âS", "GALDAMES VERGARA FELIPE ESTEBAN", "GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO", 
                "GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA", "GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO", "GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN", 
                "HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO", "LOBOS C√ÅCERES ANTONIA PAZ", "MART√çNEZ LIZANA AARON ALEJANDRO", 
                "MEZA CARRASCO BENJAM√çN INTI", "MI√ëO GONZALEZ CATALINA ANDREA", "P√âREZ COR√ìN MANUEL IGNACIO", 
                "SAMANIEGO CORTEZ JAKSON FERGIE", "SEP√öLVEDA SALAZAR SOF√çA ANTONIA", "TAPIA ACU√ëA GABRIEL ANTONIO", 
                "TORREALBA MOYA FLORVELIS DE LOS ANGELES", "VEGA VIVANCO CRIST√ìBAL ANTONIO", "VERA NAVARRETE DANIELA ELIZABETH", 
                "VILLALOBOS ARAVENA KARINA ANGELINA", "VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS"
            ],
            'Cuarto Medio C': [
                "ARELLANO ACU√ëA MART√çN ANTONIO", "AROS √ÅVILA DAYANA IGNACIA", "CABRERA COLOMBINO MAR√çA GRACIA", 
                "COLLAO MEDINA ANA√çS VALENTINA", "DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN", "FUENTES CARRASCO YARIXA ALEJANDRA", 
                "G√ìMEZ CANCINO DANIELA ALEJANDRA", "GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA", "HONORATO TAPIA GLORIA JAVIERA", 
                "LARA RIVERA BENJAM√çN ESTEBAN", "PALACIOS SOTO JOS√â TOM√ÅS", "PEZO SANTANDER JOS√â CRIST√ìBAL", 
                "ROCHA ROJAS JOS√â PABLO WILLIAMS", "ROJAS Y√âVENES FABIANA ISIDORA", "S√ÅNCHEZ PAREJA ANDY ANTONIO", 
                "SANTANDER L√ìPEZ SIM√ìN ESTEBAN", "TRONCOSO LIZAMA SIOMARA IGNACIA", "WARNKEN ROJAS LUCIANA BERNABELA"
            ]
        };

        const courseSelect = document.getElementById('course-select');
        const studentSelect = document.getElementById('student-select');
        let studentsToPrint = [];
        let allCitations = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Auth an√≥nimo
            signInAnonymously(auth).then(() => {
                console.log("Conectado a Firebase");
                listenData();
            }).catch((error) => {
                console.error("Error Auth:", error);
                showToast("Error de conexi√≥n");
            });

            // Llenar select de cursos
            courseSelect.innerHTML = '<option value="">Selecciona un curso</option>';
            for (const course in schoolData) {
                const opt = document.createElement('option'); 
                opt.value = course; 
                opt.textContent = course;
                courseSelect.appendChild(opt);
            }
            
            // Fecha por defecto (ma√±ana)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('citation-date').value = tomorrow.toISOString().split('T')[0];
        });

        // Evento cambio de curso
        courseSelect.addEventListener('change', () => {
            const sel = courseSelect.value;
            studentSelect.innerHTML = '<option value="">Selecciona un alumno(a)</option>';
            
            if (sel && schoolData[sel]) {
                studentSelect.disabled = false;
                schoolData[sel].forEach(st => {
                    const opt = document.createElement('option'); 
                    opt.value = st; 
                    opt.textContent = st; 
                    studentSelect.appendChild(opt);
                });
            } else {
                studentSelect.disabled = true;
            }
        });

        // Escuchar datos en tiempo real
        function listenData() {
            const q = collection(db, COLLECTION_NAME);
            onSnapshot(q, (snapshot) => {
                allCitations = [];
                snapshot.forEach((doc) => { 
                    allCitations.push({ id: doc.id, ...doc.data() }); 
                });
                
                // Ordenar por fecha (m√°s reciente primero)
                allCitations.sort((a,b) => {
                    const tA = a.timestamp || '';
                    const tB = b.timestamp || '';
                    return tB.localeCompare(tA);
                });
                
                renderReport();
            });
        }

        // Agregar a la cola de impresi√≥n
        document.getElementById('add-to-print-list-btn').addEventListener('click', async () => {
            const course = courseSelect.value;
            const student = studentSelect.value;
            const date = document.getElementById('citation-date').value;
            const time = document.getElementById('citation-time').value;
            const reason = document.getElementById('reason-select').value;
            const mode = document.getElementById('mode-select').value;
            const teacher = document.getElementById('teacher-input').value; 
            const obs = document.getElementById('obs-input').value.trim();

            if (!course || !student || !date || !time || !teacher) return showToast('Faltan datos obligatorios.');

            const now = new Date();
            const record = {
                course, student, citationDate: date, citationTime: time, reason, mode, teacher, obs,
                timestamp: now.toISOString(),
                createdAt: now.toLocaleString('es-CL')
            };

            try {
                // Guardar en Firebase
                await addDoc(collection(db, COLLECTION_NAME), record);
                
                // Agregar a lista local de impresi√≥n
                studentsToPrint.push(record);
                renderStudentsToPrint();
                
                // Resetear selecci√≥n de alumno
                studentSelect.value = '';
                showToast('‚úÖ Citaci√≥n generada correctamente.');
            } catch (e) {
                console.error(e);
                showToast('Error al guardar en la nube.');
            }
        });

        function renderStudentsToPrint() {
            const list = document.getElementById('print-list');
            const container = document.getElementById('print-list-container');
            list.innerHTML = '';
            
            if (studentsToPrint.length > 0) {
                container.classList.remove('hidden');
                studentsToPrint.forEach((a, idx) => {
                    list.innerHTML += `<li class="flex justify-between border-b pb-1 bg-white p-2 rounded shadow-sm mb-1">
                        <div>
                            <span class="font-bold block text-purple-800">${a.student}</span>
                            <span class="text-xs text-gray-500">${a.citationDate} ${a.citationTime} - ${a.reason}</span>
                        </div>
                        <button class="text-red-500 font-bold px-2 hover:bg-red-50 rounded" onclick="window.removeFromPrint(${idx})">√ó</button>
                    </li>`;
                });
            } else {
                container.classList.add('hidden');
            }
        }

        // Funciones globales para botones din√°micos
        window.removeFromPrint = (idx) => { studentsToPrint.splice(idx, 1); renderStudentsToPrint(); };
        document.getElementById('clear-print-list-btn').onclick = () => { studentsToPrint = []; renderStudentsToPrint(); };

        // Imprimir Colillas
        document.getElementById('print-collective-btn').onclick = () => {
            if(studentsToPrint.length === 0) return;
            const printable = document.getElementById('printable-area');
            printable.innerHTML = ''; 

            studentsToPrint.forEach(s => {
                const [y, m, d] = s.citationDate.split('-');
                const datePretty = `${d}/${m}/${y}`;

                const card = document.createElement('div');
                card.className = 'citation-slip';
                card.innerHTML = `
                    <div class="slip-left">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; border-bottom:1px solid #000; padding-bottom:5px;">
                            <img src="logo.jpg" style="height:40px;" onerror="this.style.display='none'">
                            <div>
                                <h3 style="margin:0; font-size:14px; font-weight:bold; text-transform:uppercase;">Citaci√≥n de Apoderado</h3>
                                <p style="margin:0; font-size:10px;">Escuela Agr√≠cola Sagrados Corazones</p>
                            </div>
                        </div>
                        
                        <p style="font-size:12px; text-align:justify; margin-bottom:8px;">
                            Estimado Apoderado, se cita a usted a una entrevista escolar relacionada con su pupilo 
                            <strong>${s.student}</strong> del curso <strong>${s.course}</strong>.
                        </p>

                        <div style="background:#f3f4f6; padding:10px; border:1px solid #ddd; font-size:11px;">
                            <p style="margin:2px 0;"><strong>üìÖ Fecha:</strong> ${datePretty} &nbsp;&nbsp; <strong>‚è∞ Hora:</strong> ${s.citationTime}</p>
                            <p style="margin:2px 0;"><strong>üìç Modalidad:</strong> ${s.mode}</p>
                            <p style="margin:2px 0;"><strong>üìã Motivo:</strong> ${s.reason}</p>
                            <p style="margin:2px 0;"><strong>üë§ Solicita:</strong> ${s.teacher}</p>
                            ${s.obs ? `<p style="margin:2px 0; font-style:italic;">Nota: ${s.obs}</p>` : ''}
                        </div>
                        
                        <p style="font-size:10px; margin-top:5px; text-align:center;">Se ruega asistencia y puntualidad.</p>
                    </div>

                    <div class="slip-right">
                        <div>
                            <p style="font-size:10px; font-weight:bold; text-decoration:underline;">TOMA DE CONOCIMIENTO</p>
                        </div>
                        
                        <div style="border-bottom:1px solid #000; height:40px; margin-bottom:5px;"></div>
                        <p style="font-size:9px;">Firma Apoderado</p>

                        <div style="border-bottom:1px solid #000; height:30px; margin-bottom:5px;"></div>
                        <p style="font-size:9px;">Firma Alumno</p>
                    </div>
                `;
                printable.appendChild(card);
            });

            window.print();
            studentsToPrint = []; 
            renderStudentsToPrint();
        };

        // Imprimir Reporte Diario
        document.getElementById('print-report-btn').onclick = () => {
            if(allCitations.length === 0) return showToast('No hay registros.');

            const printable = document.getElementById('printable-area');
            printable.innerHTML = `
                <div style="width:100%;">
                    <h2 style="text-align:center; margin-bottom:10px; font-size:18px;">REPORTE DE CITACIONES</h2>
                    <p style="text-align:center; font-size:12px; margin-bottom:20px;">Fecha Emisi√≥n: ${new Date().toLocaleDateString()} | Total: ${allCitations.length}</p>
                    <table style="width:100%; border-collapse:collapse; font-size:11px; page-break-inside: auto;">
                        <thead style="display: table-header-group;">
                            <tr style="background:#eee;">
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Fecha Cita</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Estudiante</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Motivo / Profesor</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Modalidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allCitations.map(a => `
                                <tr style="page-break-inside: avoid; page-break-after: auto;">
                                    <td style="border:1px solid #999; padding:6px;">${a.citationDate} ${a.citationTime}</td>
                                    <td style="border:1px solid #999; padding:6px;"><b>${a.student}</b><br>${a.course}</td>
                                    <td style="border:1px solid #999; padding:6px;">${a.reason}<br><span style="color:#666;">Prof: ${a.teacher}</span></td>
                                    <td style="border:1px solid #999; padding:6px;">${a.mode}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top:20px; text-align:right; font-size:10px; color:#666;">Generado por ProfeAle System</div>
                </div>
            `;
            
            const style = document.createElement('style');
            style.innerHTML = `@page { size: Letter; margin: 1cm; } #printable-area { display: block !important; position: relative !important; } .citation-slip { display: none; }`;
            document.head.appendChild(style);
            window.print();
            setTimeout(() => document.head.removeChild(style), 1000);
        };

        function renderReport() {
            const tbody = document.getElementById('report-body');
            const table = document.getElementById('report-table');
            const placeholder = document.getElementById('report-placeholder');
            tbody.innerHTML = '';
            const displayData = allCitations.slice(0, 15);

            if (displayData.length > 0) {
                placeholder.classList.add('hidden');
                table.classList.remove('hidden');
                displayData.forEach((a) => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="p-2 border-b text-xs text-gray-500">${a.citationDate}<br>${a.citationTime}</td>
                            <td class="p-2 border-b"><div class="font-bold text-gray-700 text-xs">${a.student}</div><div class="text-[10px] text-purple-600">${a.course}</div></td>
                            <td class="p-2 border-b text-xs"><div class="font-bold">${a.reason}</div><div class="text-[10px] text-gray-500">${a.teacher}</div></td>
                            <td class="p-2 border-b text-right"><button onclick="window.deleteItem('${a.id}')" class="text-red-500 text-xs hover:bg-red-50 p-1 rounded">üóëÔ∏è</button></td>
                        </tr>`;
                });
            } else { placeholder.classList.remove('hidden'); table.classList.add('hidden'); }
        }

        window.deleteItem = async (id) => { if(confirm('¬øEliminar este registro de la nube?')) { try { await deleteDoc(doc(db, COLLECTION_NAME, id)); showToast('Registro eliminado.'); } catch(e) { showToast('Error al eliminar.'); } } };
        document.getElementById('clear-data-btn').onclick = () => alert("Esta funci√≥n solo limpia la vista local. Para eliminar registros, usa el bot√≥n de eliminar individual.");
        function showToast(msg) { const box = document.getElementById('message-box'); box.innerText = msg; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 3000); }
        window.removeFromPrint = removeFromPrint; window.deleteItem = deleteItem;
    </script>
</body>
</html>