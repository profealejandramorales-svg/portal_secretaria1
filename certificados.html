<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificados 2026 - Escuela Agr√≠cola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f3f4f6; }
        
        /* HOJA CARTA EST√ÅNDAR */
        .certificate-page { 
            position: relative; 
            width: 216mm; 
            min-height: 279mm; 
            padding: 25mm 20mm; 
            background: white;
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-size: 12pt; 
            line-height: 1.5;
        }
        
        .tab-button.active { background-color: #15803d; color: white; }
        
        /* IMPRESI√ìN LIMPIA */
        @media print {
            body * { visibility: hidden; }
            #certificate-container, #certificate-container * { visibility: visible; }
            #certificate-container { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; 
                border: none; box-shadow: none; 
            }
            .no-print { display: none !important; }
            @page { size: letter; margin: 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 font-sans">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden no-print">
        
        <header class="bg-green-800 text-white p-5 text-center shadow-md flex items-center justify-center gap-4">
            <img src="logo.jpg" alt="Logo" class="h-16 bg-white rounded-full p-1" onerror="this.style.display='none'">
            <div>
                <h1 class="text-2xl font-bold font-sans">Generador de Certificados</h1>
                <p class="text-green-200 text-xs font-sans">Sistema Integrado de Gesti√≥n Escolar</p>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50">
            <button class="tab-button active flex-1 py-3 font-bold text-gray-600 hover:bg-green-50 transition font-sans" onclick="switchTab('generator')">
                üìÑ Emitir Documento
            </button>
            <button class="tab-button flex-1 py-3 font-bold text-gray-600 hover:bg-green-50 transition font-sans" onclick="switchTab('manage')">
                üë• Gesti√≥n y Datos
            </button>
        </div>

        <div id="tab-generator" class="p-6 sm:p-8 font-sans">
            <div class="bg-green-50 rounded-lg p-5 border border-green-100 mb-6 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-green-800 uppercase mb-1">1. A√±o Acad√©mico</label>
                        <select id="year-select" class="w-full p-2 border rounded font-bold text-green-900 text-sm bg-green-50" disabled>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">2. Curso (N√≥mina 2026)</label>
                        <select id="course-select" class="w-full p-2 border rounded text-sm" onchange="loadStudentsByCourse()">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">3. Estudiante</label>
                        <select id="student-select" class="w-full p-2 border rounded disabled:bg-gray-100 text-sm" disabled onchange="selectStudent()">
                            <option value="">‚Üê Seleccione curso</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="action-zone" class="hidden">
                <div class="flex items-center justify-between bg-white border border-gray-200 p-4 rounded-lg mb-6 shadow-sm">
                    <div>
                        <h3 class="text-md font-bold text-gray-800"><span id="display-name" class="text-green-700"></span></h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">RUT: <span id="display-rut" class="font-bold text-gray-700 bg-gray-100 px-2 py-0.5 rounded">--</span></p>
                    </div>
                    <div class="text-right">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">CURSO A CERTIFICAR</label>
                        <input type="text" id="final-course-input" class="w-20 text-center font-bold border-b border-green-500 focus:outline-none text-lg text-gray-800 bg-transparent" value="" readonly>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3 justify-center">
                    <button onclick="generateCertificate('regular')" class="px-5 py-2.5 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 text-sm transition">
                        üéì Alumno Regular
                    </button>
                    <button onclick="generateCertificate('matricula')" class="px-5 py-2.5 bg-yellow-600 text-white font-bold rounded shadow hover:bg-yellow-700 text-sm transition">
                        üìù Certificado Matr√≠cula
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-manage" class="hidden p-6 sm:p-8 bg-gray-50 font-sans">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-md font-bold text-gray-800 mb-3">‚ûï Ingresar Alumno Nuevo</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="text-xs font-bold text-gray-500">Curso 2026</label><input type="text" id="new-course" placeholder="Ej: 1A" class="w-full p-2 border rounded uppercase text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500">RUT</label><input type="text" id="new-rut" placeholder="12345678-9" class="w-full p-2 border rounded uppercase text-sm"></div>
                    </div>
                    <div class="mb-3"><label class="text-xs font-bold text-gray-500">Nombre Completo (Apellidos Nombres)</label><input type="text" id="new-name" placeholder="PEREZ LOPEZ, JUAN" class="w-full p-2 border rounded uppercase text-sm"></div>
                    <button onclick="addStudentToDB()" class="w-full py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 text-sm">Guardar en Base de Datos</button>
                </div>

                <div class="bg-red-50 p-5 rounded-lg border border-red-200">
                    <h3 class="text-md font-bold text-red-800 mb-1">‚ö†Ô∏è Carga Masiva de N√≥mina</h3>
                    <p class="text-xs text-red-600 mb-3">Este bot√≥n borrar√° la base de datos actual y cargar√° la <strong>N√≥mina Oficial 2026</strong> completa.</p>
                    <button onclick="fullDatabaseReset()" class="w-full py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 text-sm flex justify-center items-center gap-2">
                        üóëÔ∏è BORRAR Y CARGAR N√ìMINA 2026
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="certificate-container" class="hidden mt-8 mb-10 shadow-lg mx-auto w-fit">
        <div id="certificate-content"></div>
        <div class="no-print text-center py-4 bg-gray-100 border-t">
            <button onclick="window.print()" class="px-6 py-2 bg-gray-800 text-white font-bold rounded shadow hover:bg-black text-sm">
                üñ®Ô∏è Imprimir
            </button>
            <button onclick="document.getElementById('certificate-container').classList.add('hidden')" class="ml-4 px-4 py-2 text-gray-500 text-sm underline hover:text-red-500">
                Cerrar Vista
            </button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const firebaseConfig = { apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I", authDomain: "suspenciones-40d0c.firebaseapp.com", projectId: "suspenciones-40d0c", storageBucket: "suspenciones-40d0c.firebasestorage.app", messagingSenderId: "853418739042", appId: "1:853418739042:web:d051befb99cd2acdd4583b", measurementId: "G-L00J7XN6Y1" };
        
        // DATOS INSTITUCIONALES
        const SCHOOL_NAME = "Escuela Agr√≠cola Sagrados Corazones"; 
        const LOCATION = "Villa Alegre";
        const DIRECTOR_NAME = "MIGUEL D√çAZ JARA";
        const DECREE = "Decreto Cooperador de la funci√≥n Educacional del Estado N¬∞ 17.576 del 10 de septiembre de 1965";

        // N√ìMINA OFICIAL 2026
        const NOMINA_OFICIAL = [
            {"curso": "1A", "rut": "23756366-2", "nombre": "√ÅLVAREZ FA√öNDEZ MATEO VICENTE"},
            {"curso": "1A", "rut": "23632281-5", "nombre": "CASTILLO ARAVENA MAITE PASCAL"},
            {"curso": "1A", "rut": "23630802-2", "nombre": "COLLADO PUENTES SANTINO ALEXANDER"},
            {"curso": "1A", "rut": "23466096-9", "nombre": "CONCHA TORREALBA JOAQU√çN IGNACIO"},
            {"curso": "1A", "rut": "23797819-6", "nombre": "D√çAZ MALUENDA ESTEFAN√çA ANTONIA"},
            {"curso": "1A", "rut": "23927686-5", "nombre": "DONAIRE ROJAS MAITE EMILIA ESTER"},
            {"curso": "1A", "rut": "23552792-8", "nombre": "ESPINOZA CACHA√ëA LISBET ALEXANDRA"},
            {"curso": "1A", "rut": "23560082-K", "nombre": "FERRADA ALBORNOZ AGUST√çN ALEXIS"},
            {"curso": "1A", "rut": "23329694-5", "nombre": "FUENTEMAVIDA BARROS OSCAR ANTONIO"},
            {"curso": "1A", "rut": "23620840-0", "nombre": "JAQUE PACHECO DAMI√ÅN IGNACIO"},
            {"curso": "1A", "rut": "23308540-5", "nombre": "JARAMILLO VILLAR MATT HOST"},
            {"curso": "1A", "rut": "23355954-7", "nombre": "L√ìPEZ ACU√ëA MARCO EMILIO"},
            {"curso": "1A", "rut": "23903961-8", "nombre": "L√ìPEZ VILLAR FRANCO IGNACIO"},
            {"curso": "1A", "rut": "23032545-6", "nombre": "MESA D√çAZ GONZALO IGNACIO"},
            {"curso": "1A", "rut": "23520544-0", "nombre": "MEZA CARRASCO CRISTIAN ALFONSO"},
            {"curso": "1A", "rut": "23668420-2", "nombre": "MORALES GARRIDO NICOL√ÅS ANTONIO"},
            {"curso": "1A", "rut": "23830831-3", "nombre": "ORTEGA DA SILVA EMILIA CATALINA SOPHIA"},
            {"curso": "1A", "rut": "23653817-6", "nombre": "PEREIRA TAPIA KEVIN RUB√âN"},
            {"curso": "1A", "rut": "23679011-8", "nombre": "RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS"},
            {"curso": "1A", "rut": "23488123-K", "nombre": "RAM√çREZ VALD√âS MARTINA POLETTE"},
            {"curso": "1A", "rut": "23493746-4", "nombre": "RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO"},
            {"curso": "1A", "rut": "22988470-0", "nombre": "RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR"},
            {"curso": "1A", "rut": "23710287-8", "nombre": "ROJAS √ìRDENES TRACY MAIDEN"},
            {"curso": "1A", "rut": "23577058-K", "nombre": "S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS"},
            {"curso": "1A", "rut": "100685011-8", "nombre": "SOLIZ OLGUIN BRAYAN"},
            {"curso": "1A", "rut": "23937949-4", "nombre": "VALENZUELA MU√ëOZ MAGDALENA BEL√âN"},
            {"curso": "2A", "rut": "23376817-0", "nombre": "ALBURQUENQUE DEL GRECCO EMILYA ANTONIA"},
            {"curso": "2A", "rut": "22922460-3", "nombre": "ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS"},
            {"curso": "2A", "rut": "23367234-3", "nombre": "ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS"},
            {"curso": "2A", "rut": "22927087-7", "nombre": "ARAYA DOM√çNGUEZ ALEX FABI√ÅN"},
            {"curso": "2A", "rut": "22826488-1", "nombre": "ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO"},
            {"curso": "2A", "rut": "23251746-8", "nombre": "ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN"},
            {"curso": "2A", "rut": "23461777-K", "nombre": "BAEZ DONOSO LUKAS ALFONSO"},
            {"curso": "2A", "rut": "23282399-2", "nombre": "CARO BUSTOS KRISCHNA ESTEFANIA"},
            {"curso": "2A", "rut": "23355953-9", "nombre": "CONTRERAS SALGADO HADEEY ALEJANDRA"},
            {"curso": "2A", "rut": "23545428-9", "nombre": "CUMINAO VIDAL CATALINA ANDREA"},
            {"curso": "2A", "rut": "23224652-9", "nombre": "D√çAZ MALUENDA MIGUEL ALBERTO"},
            {"curso": "2A", "rut": "23644472-4", "nombre": "IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA"},
            {"curso": "2A", "rut": "23337375-3", "nombre": "KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL"},
            {"curso": "2A", "rut": "23389072-3", "nombre": "LAGOS LASTRA ALEXANDRA DANAE"},
            {"curso": "2A", "rut": "23498596-5", "nombre": "L√ìPEZ L√ìPEZ LUCIANO ANTONIO"},
            {"curso": "2A", "rut": "23153879-8", "nombre": "L√ìPEZ NOVOA EYDAN DAMI√ÅN"},
            {"curso": "2A", "rut": "23396870-6", "nombre": "MALDONADO FLORES ANTONELLA BEL√âN"},
            {"curso": "2A", "rut": "23548214-2", "nombre": "MONTECINO D√çAZ VALESKA BEL√âN"},
            {"curso": "2A", "rut": "23391772-9", "nombre": "MOYA REYES MATEO ANTONIO BENJAM√çN"},
            {"curso": "2A", "rut": "23366642-4", "nombre": "MU√ëOZ CONTRERAS LUIS GABRIEL"},
            {"curso": "2A", "rut": "23622121-0", "nombre": "MU√ëOZ LUNA ROGER JOEL"},
            {"curso": "2A", "rut": "23329866-2", "nombre": "NAVARRO VILLANUEVA KARLA PAZ"},
            {"curso": "2A", "rut": "23388136-8", "nombre": "ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS"},
            {"curso": "2A", "rut": "23432193-5", "nombre": "OSES CAMPOS VALENTINA ABIGAIL"},
            {"curso": "2A", "rut": "23190411-5", "nombre": "PALMA ORELLANA ANTONELLA FRANCISCA"},
            {"curso": "2A", "rut": "23605196-K", "nombre": "PEREIRA ORELLANA MONSERRAT ALAMIRA"},
            {"curso": "2A", "rut": "23415461-3", "nombre": "P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA"},
            {"curso": "2A", "rut": "23479449-3", "nombre": "P√âREZ QUEVEDO CONSTANZA TRINIDAD"},
            {"curso": "2A", "rut": "23640108-1", "nombre": "QUEZADA NARANJO FELIPE ALONSO"},
            {"curso": "2A", "rut": "23534317-7", "nombre": "RAM√çREZ VILLALOBOS DUVAN EMILIO"},
            {"curso": "2A", "rut": "23112966-9", "nombre": "RIQUELME SANTOS BENJAM√çN ALONSO"},
            {"curso": "2A", "rut": "23290841-6", "nombre": "ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD"},
            {"curso": "2A", "rut": "23264828-7", "nombre": "ROJAS LEIVA EDUARDO JAVIER"},
            {"curso": "2A", "rut": "23301500-8", "nombre": "SALAZAR SALAS PEDRO JOS√â"},
            {"curso": "2A", "rut": "23679554-3", "nombre": "SANTANDER L√ìPEZ MAR√çA JOS√â"},
            {"curso": "2A", "rut": "23631475-8", "nombre": "TAPIA CASTILLA JEANFRANCO PATRICK"},
            {"curso": "2A", "rut": "23007625-1", "nombre": "URBINA C√ÅCERES FRANCHESCA POULETTE"},
            {"curso": "2A", "rut": "23555453-4", "nombre": "VARGAS MORAGA MARTINA SAYEN"},
            {"curso": "2A", "rut": "22763630-0", "nombre": "V√ÅSQUEZ AGUILERA SCARLET NICOLE"},
            {"curso": "2A", "rut": "23584521-0", "nombre": "V√ÅSQUEZ ZALDUENDO AMANDA ISABEL"},
            {"curso": "2A", "rut": "23296637-8", "nombre": "VERA BRAVO FLORENCIA ANTONIA"},
            {"curso": "2A", "rut": "23616701-1", "nombre": "Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN"},
            {"curso": "2A", "rut": "23404221-1", "nombre": "ZABALAGA COFR√â DAMI√ÅN ANDR√âS"},
            {"curso": "3A", "rut": "23006149-1", "nombre": "AHUMADA ROJAS TRINIDAD BEL√âN"},
            {"curso": "3A", "rut": "22774362-K", "nombre": "CORNEJO CASTILLO OSCAR GABRIEL"},
            {"curso": "3A", "rut": "23236242-1", "nombre": "ESPINOZA PE√ëALILLO BRAYAN JES√öS"},
            {"curso": "3A", "rut": "23229539-2", "nombre": "FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO"},
            {"curso": "3A", "rut": "22827535-2", "nombre": "JARAMILLO VILLAR EMILIO SCOTT"},
            {"curso": "3A", "rut": "23321258-K", "nombre": "L√ìPEZ VILLAR MART√çN ALONSO"},
            {"curso": "3A", "rut": "23255825-3", "nombre": "MEZA COLIM√ÅN ANGEL BLAS"},
            {"curso": "3A", "rut": "23285276-3", "nombre": "MIRANDA MU√ëOZ ALEXANDRA JAVIERA"},
            {"curso": "3A", "rut": "22932822-0", "nombre": "MORAGA PACHECO RENATO IGNACIO"},
            {"curso": "3A", "rut": "22617512-1", "nombre": "MORALES REIM√ÅN ALFONSO TOM√ÅS"},
            {"curso": "3A", "rut": "22876195-8", "nombre": "ORELLANA GARRIDO MAT√çAS LEANDRO"},
            {"curso": "3A", "rut": "23054557-K", "nombre": "PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO"},
            {"curso": "3A", "rut": "23029359-7", "nombre": "PINTO TOBAR JORD√ÅN AMARO"},
            {"curso": "3A", "rut": "23086976-6", "nombre": "RECABAL Y√Å√ëEZ KEVIN ANDR√âS"},
            {"curso": "3A", "rut": "22922664-9", "nombre": "SANDOVAL CERPA VICENTE ESTEBAN"},
            {"curso": "3A", "rut": "23230279-8", "nombre": "SOTO NARANJO CHRISTOPHER"},
            {"curso": "3A", "rut": "22907717-1", "nombre": "VEKARIC VERDEJO MART√çN"},
            {"curso": "3A", "rut": "23146366-6", "nombre": "VIELMA ZABALAGA JOAN MANUEL"},
            {"curso": "3C", "rut": "23099931-7", "nombre": "BRAVO MENARES ALEX JOHAN"},
            {"curso": "3C", "rut": "23200990-K", "nombre": "CARRASCO LEIVA BENJAM√çN IGNACIO"},
            {"curso": "3C", "rut": "23194660-8", "nombre": "ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER"},
            {"curso": "3C", "rut": "23090163-5", "nombre": "ESPINOSA TORRES FERNANDA ELENA"},
            {"curso": "3C", "rut": "23121508-5", "nombre": "GONZ√ÅLEZ SALAZAR EMILIA CATALINA"},
            {"curso": "3C", "rut": "23132468-2", "nombre": "MEDEL OJEDA LE√ìN IGNACIO"},
            {"curso": "3C", "rut": "23097156-0", "nombre": "OLIVARES VALENZUELA ALONSO IGNACIO"},
            {"curso": "3C", "rut": "22804086-K", "nombre": "OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA"},
            {"curso": "3C", "rut": "23113000-4", "nombre": "PUNOY MEDEL MILLARAY ANG√âLICA"},
            {"curso": "3C", "rut": "23118361-2", "nombre": "QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO"},
            {"curso": "3C", "rut": "23284002-1", "nombre": "RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO"},
            {"curso": "3C", "rut": "23244598-K", "nombre": "RIQUELME COLOMA DALIA CONSTANZA"},
            {"curso": "3C", "rut": "23141589-0", "nombre": "RIVERA ABARZA CONSTANZA VICTORIA"},
            {"curso": "3C", "rut": "23164383-4", "nombre": "SAAVEDRA BRAVO FLORENCIA ALEJANDRA"},
            {"curso": "3C", "rut": "23304433-4", "nombre": "SALGADO ROJAS VICENTE MOIS√âS"},
            {"curso": "3C", "rut": "23294557-5", "nombre": "SANTIS CASSEUS TEIVA SCARLETT"},
            {"curso": "3C", "rut": "22912548-6", "nombre": "SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN"},
            {"curso": "3C", "rut": "23209204-1", "nombre": "TOLEDO ALBORNOZ ANTONELLA INES"},
            {"curso": "3C", "rut": "23115030-7", "nombre": "VENEGAS ARRIAGADA ANTONIA EDITH"},
            {"curso": "4A", "rut": "22717035-2", "nombre": "ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA"},
            {"curso": "4A", "rut": "22202028-K", "nombre": "BAHAMONDE MU√ëOZ ARIEL LEON"},
            {"curso": "4A", "rut": "22932851-4", "nombre": "CAMPOS MU√ëOZ CRISTOPHER JES√öS"},
            {"curso": "4A", "rut": "22587064-0", "nombre": "CANCINO OR√ìSTICA VICENTE GASPAR"},
            {"curso": "4A", "rut": "23038091-0", "nombre": "CARO URRUTIA CONSUELO ANTONIA"},
            {"curso": "4A", "rut": "22935345-4", "nombre": "CARRASCO GONZ√ÅLEZ CAMILA ANDREA"},
            {"curso": "4A", "rut": "22852052-7", "nombre": "COFR√â CASTILLO ANTONIO ANDR√âS"},
            {"curso": "4A", "rut": "22897408-0", "nombre": "GALDAMES VERGARA FELIPE ESTEBAN"},
            {"curso": "4A", "rut": "22152106-4", "nombre": "GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO"},
            {"curso": "4A", "rut": "22820588-5", "nombre": "GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA"},
            {"curso": "4A", "rut": "22565627-4", "nombre": "GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO"},
            {"curso": "4A", "rut": "22808692-4", "nombre": "GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN"},
            {"curso": "4A", "rut": "22644932-9", "nombre": "HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO"},
            {"curso": "4A", "rut": "22448022-9", "nombre": "LOBOS C√ÅCERES ANTONIA PAZ"},
            {"curso": "4A", "rut": "22970003-0", "nombre": "MART√çNEZ LIZANA AARON ALEJANDRO"},
            {"curso": "4A", "rut": "22482618-4", "nombre": "MEZA CARRASCO BENJAM√çN INTI"},
            {"curso": "4A", "rut": "22858572-6", "nombre": "MI√ëO GONZALEZ CATALINA ANDREA"},
            {"curso": "4A", "rut": "22839912-4", "nombre": "P√âREZ COR√ìN MANUEL IGNACIO"},
            {"curso": "4A", "rut": "100710921-7", "nombre": "SAMANIEGO CORTEZ JAKSON FERGIE"},
            {"curso": "4A", "rut": "22889391-9", "nombre": "SEP√öLVEDA SALAZAR SOF√çA ANTONIA"},
            {"curso": "4A", "rut": "22709426-5", "nombre": "TAPIA ACU√ëA GABRIEL ANTONIO"},
            {"curso": "4A", "rut": "100793606-7", "nombre": "TORREALBA MOYA FLORVELIS DE LOS ANGELES"},
            {"curso": "4A", "rut": "23022549-4", "nombre": "VEGA VIVANCO CRIST√ìBAL ANTONIO"},
            {"curso": "4A", "rut": "22903476-6", "nombre": "VERA NAVARRETE DANIELA ELIZABETH"},
            {"curso": "4A", "rut": "22792420-9", "nombre": "VILLALOBOS ARAVENA KARINA ANGELINA"},
            {"curso": "4A", "rut": "22733377-4", "nombre": "VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS"},
            {"curso": "4C", "rut": "22558171-1", "nombre": "ARELLANO ACU√ëA MART√çN ANTONIO"},
            {"curso": "4C", "rut": "22897577-K", "nombre": "AROS √ÅVILA DAYANA IGNACIA"},
            {"curso": "4C", "rut": "22339310-1", "nombre": "CABRERA COLOMBINO MAR√çA GRACIA"},
            {"curso": "4C", "rut": "23048274-8", "nombre": "COLLAO MEDINA ANA√çS VALENTINA"},
            {"curso": "4C", "rut": "22783846-9", "nombre": "DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN"},
            {"curso": "4C", "rut": "22865819-7", "nombre": "FUENTES CARRASCO YARIXA ALEJANDRA"},
            {"curso": "4C", "rut": "22971225-K", "nombre": "G√ìMEZ CANCINO DANIELA ALEJANDRA"},
            {"curso": "4C", "rut": "22698950-1", "nombre": "GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA"},
            {"curso": "4C", "rut": "22665539-5", "nombre": "HONORATO TAPIA GLORIA JAVIERA"},
            {"curso": "4C", "rut": "22907525-K", "nombre": "LARA RIVERA BENJAM√çN ESTEBAN"},
            {"curso": "4C", "rut": "22801082-0", "nombre": "PALACIOS SOTO JOS√â TOM√ÅS"},
            {"curso": "4C", "rut": "22477831-7", "nombre": "PEZO SANTANDER JOS√â CRIST√ìBAL"},
            {"curso": "4C", "rut": "22796354-9", "nombre": "ROCHA ROJAS JOS√â PABLO WILLIAMS"},
            {"curso": "4C", "rut": "22876139-7", "nombre": "ROJAS Y√âVENES FABIANA ISIDORA"},
            {"curso": "4C", "rut": "22916573-9", "nombre": "S√ÅNCHEZ PAREJA ANDY ANTONIO"},
            {"curso": "4C", "rut": "22845486-9", "nombre": "SANTANDER L√ìPEZ SIM√ìN ESTEBAN"},
            {"curso": "4C", "rut": "23004590-9", "nombre": "TRONCOSO LIZAMA SIOMARA IGNACIA"},
            {"curso": "4C", "rut": "23009921-9", "nombre": "WARNKEN ROJAS LUCIANA BERNABELA"}
        ];

        let db, ALL_STUDENTS = [], CURRENT_STUDENT = null;

        window.addEventListener('load', async () => {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await loadStudentsFromDB();
            } catch (e) { Swal.fire('Error', 'No se pudo conectar a la base de datos.', 'error'); }
        });

        async function loadStudentsFromDB() {
            ALL_STUDENTS = [];
            const courseSelect = document.getElementById('course-select');
            courseSelect.innerHTML = '<option>Cargando...</option>';
            try {
                const snap = await db.collection("alumnos").get();
                snap.forEach(doc => { ALL_STUDENTS.push({ id: doc.id, ...doc.data() }); });
                ALL_STUDENTS.sort((a, b) => a.nombre.localeCompare(b.nombre));
                populateCourseSelect();
            } catch (e) { console.error(e); courseSelect.innerHTML = '<option>Error</option>'; }
        }

        function populateCourseSelect() {
            const select = document.getElementById('course-select');
            const courses = [...new Set(ALL_STUDENTS.map(s => s.curso))].sort();
            select.innerHTML = '<option value="">-- Seleccione Curso --</option>';
            courses.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
        }

        window.loadStudentsByCourse = function() {
            const course = document.getElementById('course-select').value;
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">-- Seleccione Alumno --</option>';
            select.disabled = true;
            document.getElementById('action-zone').classList.add('hidden');
            if (course) {
                const filtered = ALL_STUDENTS.filter(s => s.curso === course);
                filtered.forEach(s => select.innerHTML += `<option value="${s.id}">${s.nombre}</option>`);
                select.disabled = false;
            }
        };

        window.selectStudent = function() {
            const id = document.getElementById('student-select').value;
            if (!id) { document.getElementById('action-zone').classList.add('hidden'); return; }
            CURRENT_STUDENT = ALL_STUDENTS.find(s => s.id === id);
            
            document.getElementById('display-name').innerText = CURRENT_STUDENT.nombre;
            const rut = CURRENT_STUDENT.rut || "SIN DATOS";
            document.getElementById('display-rut').innerText = rut;
            document.getElementById('display-rut').className = rut === "SIN DATOS" ? "font-bold text-red-500 bg-red-100 px-2 py-0.5 rounded" : "font-bold text-gray-700 bg-gray-100 px-2 py-0.5 rounded";
            
            // L√ìGICA SIMPLIFICADA PARA 2026: No hay promoci√≥n, se usa el curso de la n√≥mina
            document.getElementById('final-course-input').value = CURRENT_STUDENT.curso;
            document.getElementById('action-zone').classList.remove('hidden');
        };

        window.generateCertificate = function(type) {
            if (!CURRENT_STUDENT) return;
            // A√±o fijo en 2026
            const year = "2026"; 
            const finalCourse = document.getElementById('final-course-input').value;
            const dateText = getFormattedDate();
            
            let title = type === 'regular' ? "CERTIFICADO DE ALUMNO REGULAR" : "CERTIFICADO DE MATR√çCULA";
            let body = type === 'regular' 
                ? `es alumno regular y se encuentra matriculado en el curso <strong>${finalCourse}</strong>, a√±o escolar <strong>${year}</strong>, de este establecimiento educacional.`
                : `ha sido aceptado y matriculado en el curso <strong>${finalCourse}</strong> para el a√±o escolar <strong>${year}</strong> en este establecimiento.`;

            const html = `
                <div class="certificate-page">
                    <div class="flex justify-between items-start mb-6">
                        <div class="text-[10pt] leading-tight">
                            <p class="font-bold uppercase">${SCHOOL_NAME}</p>
                            <p>${LOCATION}</p>
                        </div>
                        <img src="logo.jpg" alt="Logo" style="height: 70px;" onerror="this.style.display='none'">
                    </div>

                    <div class="text-center mb-8 mt-4">
                        <h2 class="text-2xl font-bold uppercase border-b-2 border-black inline-block pb-1">${title}</h2>
                    </div>

                    <div class="text-[12pt] leading-normal text-justify mb-8">
                        <p class="mb-4">
                            Quien suscribe, Director de la ${SCHOOL_NAME}, ${DECREE}, <strong>CERTIFICA</strong>:
                        </p>
                        <p class="mb-4 indent-8">
                            Que, don(a) <strong class="uppercase">${CURRENT_STUDENT.nombre}</strong>, 
                            RUT <strong>${CURRENT_STUDENT.rut || "______________"}</strong>, ${body}
                        </p>
                        <p class="indent-8">
                            Se extiende el presente certificado a petici√≥n del interesado para los fines que estime conveniente.
                        </p>
                    </div>

                    <div class="text-right mt-12 text-[12pt]">
                        <p>${dateText}</p>
                    </div>

                    <div class="mt-28 text-center">
                        <div class="inline-block border-t border-black pt-2 px-12">
                            <p class="font-bold text-lg">${DIRECTOR_NAME}</p>
                            <p class="uppercase text-xs tracking-wider">Director</p>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-4 left-0 w-full text-center text-[9px] text-gray-400 no-print">
                        Plataforma Gesti√≥n 2026 ‚Ä¢ Desarrollado por ProfeAle
                    </div>
                </div>
            `;
            document.getElementById('certificate-content').innerHTML = html;
            document.getElementById('certificate-container').classList.remove('hidden');
            document.getElementById('certificate-container').scrollIntoView({behavior: 'smooth'});
        };

        // --- FUNCI√ìN DE RESET TOTAL (CARGA DE N√ìMINA) ---
        window.fullDatabaseReset = async function() {
            if(!confirm("‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øEst√°s seguro de BORRAR TODOS los alumnos actuales y volver a cargar la n√≥mina oficial completa (con RUTs)?\n\nEsto solucionar√° los problemas de datos faltantes.")) return;
            
            Swal.fire({title: 'Restaurando Base de Datos...', text: 'Borrando registros antiguos...', didOpen: () => Swal.showLoading()});
            
            try {
                // 1. Borrar todo por lotes
                const snap = await db.collection("alumnos").get();
                let batch = db.batch();
                let count = 0;
                
                for (const doc of snap.docs) {
                    batch.delete(doc.ref);
                    count++;
                    if (count >= 100) { await batch.commit(); batch = db.batch(); count = 0; }
                }
                if (count > 0) await batch.commit();

                // 2. Insertar n√≥mina oficial
                Swal.update({ text: 'Cargando n√≥mina oficial...' });
                let batchInsert = db.batch();
                let insertCount = 0;
                
                for (const student of NOMINA_OFICIAL) {
                    const ref = db.collection("alumnos").doc();
                    batchInsert.set(ref, student);
                    insertCount++;
                    if (insertCount >= 100) { await batchInsert.commit(); batchInsert = db.batch(); insertCount = 0; }
                }
                if (insertCount > 0) await batchInsert.commit();

                await loadStudentsFromDB();
                Swal.fire('¬°Base de Datos Restaurada!', 'Se han cargado ' + NOMINA_OFICIAL.length + ' alumnos con sus RUTs correctamente.', 'success');
            } catch(e) {
                console.error(e);
                Swal.fire('Error', 'Hubo un problema durante la restauraci√≥n.', 'error');
            }
        };

        window.addStudentToDB = async function() {
            const course = document.getElementById('new-course').value.toUpperCase().trim();
            const name = document.getElementById('new-name').value.toUpperCase().trim();
            const rut = document.getElementById('new-rut').value.toUpperCase().trim();
            if (!course || !name) { Swal.fire('Error', 'Faltan datos', 'warning'); return; }
            await db.collection("alumnos").add({ nombre: name, curso: course, rut: rut });
            Swal.fire('Listo', 'Alumno guardado', 'success');
            loadStudentsFromDB();
        };

        function getFormattedDate() {
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const d = new Date();
            return `${LOCATION}, ${d.getDate()} de ${months[d.getMonth()]} de ${d.getFullYear()}`;
        }
        
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-generator').classList.add('hidden');
            document.getElementById('tab-manage').classList.add('hidden');
            document.getElementById('tab-' + tab).classList.remove('hidden');
        };
        
        window.resetSelection = function() {
            document.getElementById('action-zone').classList.add('hidden');
            document.getElementById('certificate-container').classList.add('hidden');
            if (CURRENT_STUDENT) selectStudent();
        }
    </script>
</body>
</html>