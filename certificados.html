<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Certificados Escuela Agr√≠cola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        
        /* Estilos espec√≠ficos para el certificado */
        .certificate-page {
            position: relative; 
            min-height: 800px; 
        }

        /* Clase para la marca de agua (dentro del certificado) */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #d1d5db; /* Gris claro */
            font-size: 3rem;
            font-weight: bold;
            opacity: 0.3;
            z-index: -1; 
            pointer-events: none; 
            white-space: nowrap;
        }

        /* Estilos para las pesta√±as de gesti√≥n de alumnos */
        .tab-button.active {
            background-color: #10b981; /* green-500 */
            color: white;
            border-bottom-color: transparent;
        }

        /* Estilos espec√≠ficos para la impresi√≥n del certificado */
        @media print {
            body > * {
                visibility: hidden;
            }
            #certificate-container {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                background: white;
            }
            #certificate-container .no-print {
                display: none !important;
            }
            /* Pie de p√°gina con la l√≠nea de contacto */
            @page {
                size: A4;
                margin-bottom: 20mm; 
                @bottom-center {
                    content: "Loncomilla s/n Villa Alegre ‚Äì Regi√≥n del Maule 56 ‚Äì988653956 56-971362126";
                    font-style: italic; 
                    font-size: 9pt;
                    color: #4b5563; 
                }
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        <header class="text-center mb-10 border-b-2 border-green-700 pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-green-800">
                Generador de Certificados Escolares
            </h1>
            <p class="text-lg text-gray-600 mt-2">Escuela Agr√≠cola Sagrados Corazones, Villa Alegre</p>
        </header>

        <p class="text-xs text-gray-500 text-left -mt-6 mb-4">
            Desarrollado por ProfeAle
        </p>
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-2" role="tablist">
                <button id="tab-generator-button" class="tab-button active px-4 py-2 text-sm font-medium text-gray-600 rounded-t-lg hover:bg-green-100 transition duration-150" data-tab="generator">
                    Generar Certificado
                </button>
                <button id="tab-manage-button" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 rounded-t-lg hover:bg-green-100 transition duration-150" data-tab="manage">
                    Gesti√≥n de Alumnos
                </button>
            </nav>
        </div>

        <div id="tab-content-generator">
            <section class="mb-8 space-y-4">
                
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                    <label for="year-select" class="block text-sm font-bold text-blue-800 mb-2">
                        üìÖ A√±o Acad√©mico del Certificado:
                    </label>
                    <select id="year-select" class="w-full sm:w-1/3 p-2 border-2 border-blue-300 rounded-lg bg-white text-blue-900 font-semibold focus:border-blue-500 focus:ring focus:ring-blue-200">
                        <option value="2025" selected>2025 (A√±o Actual)</option>
                        <option value="2026">2026 (Pr√≥ximo A√±o - Promoci√≥n Autom√°tica)</option>
                    </select>
                    <p class="text-xs text-blue-600 mt-1">
                        * Al seleccionar 2026, los cursos se promueven autom√°ticamente (ej: 1A pasa a 2A) y los 4¬∞ Medios se omiten.
                    </p>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Selecci√≥n de Estudiante</h2>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="sm:w-1/3">
                        <label for="course-select" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Curso:
                        </label>
                        <select id="course-select" 
                                class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white focus:border-green-500 focus:ring focus:ring-green-200 transition duration-150">
                            <option value="" disabled selected>-- Elija un curso --</option>
                        </select>
                    </div>

                    <div class="sm:w-2/3">
                        <label for="student-select" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Alumno:
                        </label>
                        <select id="student-select" disabled
                                class="w-full p-3 border-2 border-gray-300 rounded-lg bg-gray-100 focus:border-green-500 focus:ring focus:ring-green-200 transition duration-150">
                            <option value="" disabled selected>-- Seleccione un curso primero --</option>
                        </select>
                    </div>
                </div>
                
                <p id="loading-message" class="text-center text-green-600 mt-4 hidden">N√≥mina cargada correctamente.</p>
            </section>

            <section id="certificate-buttons-section" class="mt-8 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Generar Certificado para: <span id="selected-student-name" class="text-green-600"></span></h2>
                <div class="flex space-x-4 justify-start">
                    <button id="generate-regular-cert" data-type="regular" disabled
                            class="px-6 py-3 text-sm bg-green-600 text-white font-bold rounded-full hover:bg-green-700 transition duration-150 shadow-md disabled:opacity-50">
                        Certificado de Alumno Regular
                    </button>
                    <button id="generate-matricula-cert" data-type="matricula" disabled
                            class="px-6 py-3 text-sm bg-yellow-600 text-white font-bold rounded-full hover:bg-yellow-700 transition duration-150 shadow-md disabled:opacity-50">
                        Certificado de Matr√≠cula
                    </button>
                </div>
            </section>

            <div id="certificate-container" class="mt-12 hidden p-6 border-4 border-double border-green-700 rounded-lg bg-white shadow-xl">
                <div id="certificate-content"></div>

                <div class="flex justify-center mt-6 no-print">
                    <button id="print-button" 
                            class="px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3h10V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm0 6h10v3H5v-3zm0 5h10a2 2 0 002-2v-2a2 2 0 00-2-2H5a2 2 0 00-2 2v2a2 2 0 002 2zM5 7v3h10V7H5z" clip-rule="evenodd" />
                        </svg>
                        Imprimir Certificado
                    </button>
                </div>
            </div>
        </div>
        
        <div id="tab-content-manage" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Gesti√≥n de N√≥mina (Base 2025)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <section class="p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-green-700 mb-4">Ingresar Nuevo Alumno</h3>
                    <div class="space-y-3">
                        <input type="text" id="new-course" placeholder="Curso Actual (Ej: 1A, 3C)" class="w-full p-2 border rounded-lg">
                        <input type="text" id="new-rut" placeholder="RUT (sin puntos, con guion)" class="w-full p-2 border rounded-lg">
                        <input type="text" id="new-name1" placeholder="Primer Nombre" class="w-full p-2 border rounded-lg">
                        <input type="text" id="new-name2" placeholder="Segundo Nombre (Opcional)" class="w-full p-2 border rounded-lg">
                        <input type="text" id="new-apellidop" placeholder="Apellido Paterno" class="w-full p-2 border rounded-lg">
                        <input type="text" id="new-apellidom" placeholder="Apellido Materno" class="w-full p-2 border rounded-lg">
                        <button id="add-student-button" class="w-full px-4 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">
                            A√±adir Alumno
                        </button>
                        <p id="add-message" class="text-sm pt-1"></p>
                    </div>
                </section>

                <section class="p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-red-700 mb-4">Eliminar Alumno</h3>
                    <div class="space-y-3">
                        <select id="delete-course-select" class="w-full p-2 border rounded-lg">
                            <option value="" disabled selected>-- Elija un curso --</option>
                        </select>
                        <select id="delete-student-select" disabled class="w-full p-2 border rounded-lg bg-gray-100">
                            <option value="" disabled selected>-- Seleccione un alumno --</option>
                        </select>
                        <button id="delete-student-button" disabled class="w-full px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition disabled:opacity-50">
                            Eliminar Alumno Seleccionado
                        </button>
                        <p id="delete-message" class="text-sm pt-1"></p>
                    </div>
                </section>
            </div>
            
            <p class="text-xs text-gray-500 mt-6 p-2 bg-yellow-100 border-l-4 border-yellow-500">
                ‚ö†Ô∏è **Nota Importante:** La gesti√≥n de alumnos siempre trabaja sobre la base de datos original (2025). La promoci√≥n al 2026 solo se visualiza en la pesta√±a "Generar Certificado".
            </p>
        </div>
        
    </div>

    <script>
        // --- CONSTANTES DEL ESTABLECIMIENTO ---
        const SCHOOL_NAME = "Escuela Agr√≠cola Sagrados Corazones"; 
        const LOCATION = "Villa Alegre";
        const DIRECTOR_NAME = "MIGUEL D√çAZ JARA";
        const DECREE = "Decreto Cooperador de la funci√≥n Educacional del Estado N¬∞ 17.576 del 10 de septiembre de 1965";
        
        // ==============================================================================
        // --- N√ìMINA COMPLETA INCRUSTADA (Datos de tu CSV de 6 columnas) ---
        // Formato: [Curso, RUT, Nombre1, Nombre2, ApellidoP, ApellidoM]
        // ==============================================================================
        let RAW_STUDENT_DATA = [
            ['1A', '23376817-0', 'EMILYA', 'ANTONIA', 'ALBURQUENQUE', 'DEL GRECO'],
            ['1A', '22922460-3', 'BENJAM√çN', 'NICOL√ÅS', 'ANABAL√ìN', 'BELTR√ÅN'],
            ['1A', '23355953-9', 'HADEEY', 'ALEJANDRA', 'CONTRERAS', 'SALGADO'],
            ['1A', '23560082-k', 'AGUST√çN', 'ALEXIS', 'FERRADA', 'ALBORNOZ'],
            ['1A', '23644472-4', 'FERNANDA', 'MAGDALENA', 'IB√Å√ëEZ', 'GONZ√ÅLEZ'],
            ['1A', '23389072-3', 'ALEXANDRA', 'DANAE', 'LAGOS', 'LASTRA'],
            ['1A', '23498596-5', 'LUCIANO', 'ANTONIO', 'L√ìPEZ', 'L√ìPEZ'],
            ['1A', '23396870-6', 'ANTONELLA', 'BEL√âN', 'MALDONADO', 'FLORES'],
            ['1A', '22793858-7', 'IGNACIO', 'ANTONIO', 'MARIN', 'MAR√çN'],
            ['1A', '23548214-2', 'VALESKA', 'BEL√âN', 'MONTECINO', 'D√çAZ'],
            ['1A', '23366642-4', 'LUIS', 'GABRIEL', 'MU√ëOZ', 'CONTRERAS'],
            ['1A', '23622121-0', 'ROGER', 'JOEL', 'MU√ëOZ', 'LUNA'],
            ['1A', '23329866-2', 'KARLA', 'PAZ', 'NAVARRO', 'VILLANUEVA'],
            ['1A', '23388136-8', 'SEBASTI√ÅN', 'ANDR√âS', 'ORELLANA', 'ARRIAGADA'],
            ['1A', '23640108-1', 'FELIPE', 'ALONSO', 'QUEZADA', 'NARANJO'],
            ['1A', '23529637-3', 'FERNANDA', 'FLORENCIA', 'QUINTEROS', 'VERGARA'],
            ['1A', '23534317-7', 'DUVAN', 'EMILIO', 'RAM√çREZ', 'VILLALOBOS'],
            ['1A', '23679554-3', 'MAR√çA', 'JOS√â', 'SANTANDER', 'L√ìPEZ'],
            ['1A', '23631475-8', 'JEANFRANCO', 'PATRICK', 'TAPIA', 'CASTILLA'],
            ['1A', '23007625-1', 'FRANCHESCA', 'POULETTE', 'URBINA', 'C√ÅCERES'],
            ['1A', '23584521-0', 'AMANDA', 'ISABEL', 'V√ÅSQUEZ', 'ZALDUENDO'],
            ['1A', '23404221-1', 'DAMI√ÅN', 'ANDR√âS', 'ZABALAGA', 'COFR√â'],
            ['1A', '23461777-k', 'LUKAS', 'ALFONSO', 'BAEZ', 'DONOSO'],
            ['1A', '23032545-6', 'GONZALO', 'IGNACIO', 'MESA', 'D√çAZ'],
            ['1B', '23367234-3', 'NOEM√ç', 'DE JES√öS DE LAS ESTRELLAS', 'ARAVENA', 'Z√ö√ëIGA'],
            ['1B', '22826488-1', 'CRIST√ìBAL', 'ANTONIO', 'ASTUDILLO', 'CAMPOS'],
            ['1B', '23251746-8', 'BRUNO', 'FERNANDO LE√ìN', 'ASTUDILLO', 'V√ÅSQUEZ'],
            ['1B', '23545428-9', 'CATALINA', 'ANDREA', 'CUMINAO', 'VIDAL'],
            ['1B', '23224652-9', 'MIGUEL', 'ALBERTO', 'D√çAZ', 'MALUENDA'],
            ['1B', '23337375-3', 'DIDIER', 'EZEQUIEL', 'KILTAN', 'GONZ√ÅLEZ'],
            ['1B', '23355954-7', 'MARCO', 'EMILIO', 'L√ìPEZ', 'ACU√ëA'],
            ['1B', '23153879-8', 'EYDAN', 'DAMI√ÅN', 'L√ìPEZ', 'NOVOA'],
            ['1B', '20760552-2', 'FABI√ÅN', 'FELIPE', 'M√âNDEZ', 'SUAZO'],
            ['1B', '23391772-9', 'MATEO', 'ANTONIO BENJAM√çN', 'MOYA', 'REYES'],
            ['1B', '23432193-5', 'VALENTINA', 'ABIGAIL', 'OSES', 'CAMPOS'],
            ['1B', '23190411-5', 'ANTONELLA', 'FRANCISCA', 'PALMA', 'ORELLANA'],
            ['1B', '23605196-K', 'MONSERRAT', 'ALAMIRA', 'PEREIRA', 'ORELLANA'],
            ['1B', '23415461-3', 'ZADKA', 'ALEJANDRA', 'P√âREZ', 'ORMAZ√ÅBAL'],
            ['1B', '23290841-6', 'FLORENCIA', 'TRINIDAD', 'ROJAS', 'GONZ√ÅLEZ'],
            ['1B', '23264828-7', 'EDUARDO', 'JAVIER', 'ROJAS', 'LEIVA'],
            ['1B', '22763630-0', 'SCARLET', 'NICOLE', 'V√ÅSQUEZ', 'AGUILERA'],
            ['1B', '23616701-1', 'BRAYAN', 'DAMI√ÅN', 'Y√Å√ëEZ', 'GONZ√ÅLEZ'],
            ['1B', '23555453-4', 'MARTINA', 'SAYEN', 'VARGAS', 'MORAGA'],
            ['1B', '23301500-8', 'PEDRO', 'JOS√â', 'SALAZAR', 'SALAS'],
            ['1B', '23296637-8', 'FLORENCIA', 'ANTONIA', 'VERA', 'BRAVO'],
            ['1B', '23479449-3', 'CONSTANZA', 'TRINIDAD', 'P√âREZ', 'QUEVEDO'],
            ['1B', '23112966-9', 'BENJAM√çN', 'ALONSO', 'RIQUELME', 'SANTOS'],
            ['2A', '23006149-1', 'TRINIDAD', 'BEL√âN', 'AHUMADA', 'ROJAS'],
            ['2A', '23090163-5', 'FERNANDA', 'ELENA', 'ESPINOSA', 'TORRES'],
            ['2A', '23236242-1', 'BRAYAN', 'JES√öS', 'ESPINOZA', 'PE√ëALILLO'],
            ['2A', '23121508-5', 'EMILIA', 'CATALINA', 'GONZ√ÅLEZ', 'SALAZAR'],
            ['2A', '23132468-2', 'LE√ìN', 'IGNACIO', 'MEDEL', 'OJEDA'],
            ['2A', '22617512-1', 'ALFONSO', 'TOM√ÅS', 'MORALES', 'REIM√ÅN'],
            ['2A', '23054557-K', 'MAXIMILIANO', 'EDUARDO', 'PEREIRA', 'HORMAZ√ÅBAL'],
            ['2A', '23029359-7', 'JORD√ÅN', 'AMARO', 'PINTO', 'TOBAR'],
            ['2A', '23086976-6', 'KEVIN', 'ANDR√âS', 'RECABAL', 'Y√Å√ëEZ'],
            ['2A', '23284002-1', 'MAT√çAS', 'EDUARDO ANTONIO', 'RIQUELME', 'CASTILLO'],
            ['2A', '23141589-0', 'CONSTANZA', 'VICTORIA', 'RIVERA', 'ABARZA'],
            ['2A', '23294557-5', 'TEIVA', 'SCARLETT', 'SANTIS', 'CASSEUS'],
            ['2A', '22912548-6', 'KATHERINNE', 'ALEXIA BEL√âN', 'SOBARZO', 'Y√âVENES'],
            ['2A', '23209204-1', 'ANTONELLA', 'INES', 'TOLEDO', 'ALBORNOZ'],
            ['2A', '23115030-7', 'ANTONIA', 'EDITH', 'VENEGAS', 'ARRIAGADA'],
            ['2A', '23146366-6', 'JOAN', 'MANUEL', 'VIELMA', 'ZABALAGA'],
            ['2A', '23255825-3', 'ANGEL', 'BLAS', 'MEZA', 'COLIM√ÅN'],
            ['2A', '23164383-4', 'FLORENCIA', 'ALEJANDRA', 'SAAVEDRA', 'BRAVO'],
            ['2B', '22927087-7', 'ALEX', 'FABI√ÅN', 'ARAYA', 'DOM√çNGUEZ'],
            ['2B', '23099931-7', 'ALEX', 'JOHAN', 'BRAVO', 'MENARES'],
            ['2B', '23200990-K', 'BENJAM√çN', 'IGNACIO', 'CARRASCO', 'LEIVA'],
            ['2B', '23086622-8', 'CONSTANZA', 'PRISILA (DANIEL)', 'CARVAJAL', 'URRUTIA'],
            ['2B', '23194660-8', 'DIEGO', 'BENJAM√çN ALEXANDER', 'ENCINA', 'PIZARRO'],
            ['2B', '23229539-2', 'ALEJANDRO', 'ANTONIO', 'FA√öNDEZ', 'NORAMBUENA'],
            ['2B', '22827535-2', 'EMILIO', 'SCOTT', 'JARAMILLO', 'VILLAR'],
            ['2B', '23321258-K', 'MART√çN', 'ALONSO', 'L√ìPEZ', 'VILLAR'],
            ['2B', '23285276-3', 'ALEXANDRA', 'JAVIERA', 'MIRANDA', 'MU√ëOZ'],
            ['2B', '22459961-7', 'H√âCTOR', 'ANTONIO', 'MU√ëOZ', 'TRONCOSO'],
            ['2B', '23097156-0', 'ALONSO', 'IGNACIO', 'OLIVARES', 'VALENZUELA'],
            ['2B', '22804086-k', 'ANTONELLA', 'DANAE IGNACIA', 'OLIVARES', 'VALENZUELA'],
            ['2B', '22876195-8', 'MAT√çAS', 'LEANDRO', 'ORELLANA', 'GARRIDO'],
            ['2B', '23113000-4', 'MILLARAY', 'ANG√âLICA', 'PUNOY', 'MEDEL'],
            ['2B', '23118361-2', 'CRIST√ìBAL', 'PATRICIO', 'QUI√ëENAO', 'MU√ëOZ'],
            ['2B', '23244598-K', 'DALIA', 'CONSTANZA', 'RIQUELME', 'COLOMA'],
            ['2B', '23304433-4', 'VICENTE', 'MOIS√âS', 'SALGADO', 'ROJAS'],
            ['2B', '22922664-9', 'VICENTE', 'ESTEBAN ', 'SANDOVAL', 'CERPA'],
            ['2B', '23230279-8', 'CHRISTOPHER', '', 'SOTO', 'NARANJO'],
            ['2B', '22907717-1', 'MART√çN', '', 'VEKARIC', 'VERDEJO'],
            ['3A', '22717035-2', 'MARTINA', 'ALEJANDRA', 'ALC√ÅNTAR', 'GARC√çA'],
            ['3A', '22202028-K', 'ARIEL', 'LEON', 'BAHAMONDE', 'MU√ëOZ'],
            ['3A', '22932851-4', 'CRISTOPHER', 'JES√öS', 'CAMPOS', 'MU√ëOZ'],
            ['3A', '22587064-0', 'VICENTE', 'GASPAR', 'CANCINO', 'OR√ìSTICA'],
            ['3A', '22935345-4', 'CAMILA', 'ANDREA', 'CARRASCO', 'GONZ√ÅLEZ'],
            ['3A', '22852052-7', 'ANTONIO', 'ANDR√âS', 'COFR√â', 'CASTILLO'],
            ['3A', '22542992-8', 'BEL√âN', 'ALEJANDRA', 'CONTRERAS', 'VENEGAS'],
            ['3A', '22897408-0', 'FELIPE', 'ESTEBAN', 'GALDAMES', 'VERGARA'],
            ['3A', '22152106-4', 'SANTIAGO', 'HUMBERTO', 'GARC√çA', 'GONZ√ÅLEZ'],
            ['3A', '22820588-5', 'FRANCISCA', 'IGNACIA', 'GONZ√ÅLEZ', 'AMIGO'],
            ['3A', '22565627-4', 'JOAQU√çN', 'ALONSO', 'GONZ√ÅLEZ', 'SALAZAR'],
            ['3A', '22808692-4', 'ANGEL', 'MART√çN', 'GUTI√âRREZ', 'GUTI√âRREZ'],
            ['3A', '22970003-0', 'AARON', 'ALEJANDRO', 'MART√çNEZ', 'LIZANA'],
            ['3A', '22482618-4', 'BENJAM√çN', 'INTI', 'MEZA', 'CARRASCO'],
            ['3A', '22858572-6', 'CATALINA', 'ANDREA', 'MI√ëO', 'GONZALEZ'],
            ['3A', '22932822-0', 'RENATO', 'IGNACIO', 'MORAGA', 'PACHECO'],
            ['3A', '22839912-4', 'MANUEL', 'IGNACIO', 'P√âREZ', 'COR√ìN'],
            ['3A', '100710921-7', 'JAKSON', 'FERGIE', 'SAMANIEGO', 'CORTEZ'],
            ['3A', '22889391-9', 'SOF√çA', 'ANTONIA', 'SEP√öLVEDA', 'SALAZAR'],
            ['3A', '22709426-5', 'GABRIEL', 'ANTONIO', 'TAPIA', 'ACU√ëA'],
            ['3A', '23022549-4', 'CRIST√ìBAL', 'ANTONIO', 'VEGA', 'VIVANCO'],
            ['3A', '22903476-6', 'DANIELA', 'ELIZABETH', 'VERA', 'NAVARRETE'],
            ['3A', '22792420-9', 'KARINA', 'ANGELINA', 'VILLALOBOS', 'ARAVENA'],
            ['3A', '22733377-4', 'SAMIR', 'LUCIAN JESUS', 'VILLALOBOS', 'VILLALOBOS'],
            ['3A', '22644932-9', 'VICENTE', 'ALEJANDRO', 'HERN√ÅNDEZ', 'SEP√öLVEDA'],
            ['3A', '100793606-7', 'FLORVELIS', 'DE LOS ANGELES', 'TORREALBA', 'MOYA'],
            ['3A', '23038091-0', 'CONSUELO', 'ANTONIA', 'CARO', 'URRUTIA'],
            ['3A', '22448022-9', 'ANTONIA', 'PAZ', 'LOBOS', 'C√ÅCERES'],
            ['3C', '22558171-1', 'MART√çN', 'ANTONIO', 'ARELLANO', 'ACU√ëA'],
            ['3C', '22897577-K', 'DAYANA', 'IGNACIA', 'AROS', '√ÅVILA'],
            ['3C', '22339310-1', 'MAR√çA', 'GRACIA', 'CABRERA', 'COLOMBINO'],
            ['3C', '22865819-7', 'YARIXA', 'ALEJANDRA', 'FUENTES', 'CARRASCO'],
            ['3C', '22971225-K', 'DANIELA', 'ALEJANDRA', 'G√ìMEZ', 'CANCINO'],
            ['3C', '22698950-1', 'MILLARAY', 'CAROLINA', 'GUTI√âRREZ', 'CARRI√ìN'],
            ['3C', '22665539-5', 'GLORIA', 'JAVIERA', 'HONORATO', 'TAPIA'],
            ['3C', '22907525-K', 'BENJAM√çN', 'ESTEBAN', 'LARA', 'RIVERA'],
            ['3C', '22801082-0', 'JOS√â', 'TOM√ÅS', 'PALACIOS', 'SOTO'],
            ['3C', '22477831-7', 'JOS√â', 'CRIST√ìBAL', 'PEZO', 'SANTANDER'],
            ['3C', '22796354-9', 'JOS√â', 'PABLO WILLIAMS', 'ROCHA', 'ROJAS'],
            ['3C', '22876139-7', 'FABIANA', 'ISIDORA', 'ROJAS', 'Y√âVENES'],
            ['3C', '22916573-9', 'ANDY', 'ANTONIO', 'S√ÅNCHEZ', 'PAREJA'],
            ['3C', '22845486-9', 'SIM√ìN', 'ESTEBAN', 'SANTANDER', 'L√ìPEZ'],
            ['3C', '23004590-9', 'SIOMARA', 'IGNACIA', 'TRONCOSO', 'LIZAMA'],
            ['3C', '23009921-9', 'LUCIANA', 'BERNABELA', 'WARNKEN', 'ROJAS'],
            ['3C', '22783846-9', 'FRANCO', 'SEBASTI√ÅN', 'DE LA HOZ', 'VALENZUELA'],
            ['3C', '23048274-8', 'ANA√çS', 'VALENTINA', 'COLLAO', 'MEDINA'],
            ['4A', '22445092-3', 'HOMERO', 'ALEXANDER', 'AGURTO', 'CRESPO'],
            ['4A', '22051153-7', 'CATALINA', 'BELEN', 'ANDIA', 'DE LA HOZ'],
            ['4A', '22269531-7', 'ESTEBAN', 'ALEXANDER', 'FUENTES', 'GONZ√ÅLEZ'],
            ['4A', '22554952-4', 'SOF√çA', 'ELENA', 'GARC√çA', 'ROJAS'],
            ['4A', '22652303-0', 'ANTONELLA', 'CONSTANZA PAZ', 'GODOY', 'HERRERA'],
            ['4A', '22312159-4', 'KEVIN', 'ALEJANDRO', 'GONZ√ÅLEZ', 'CASTRO'],
            ['4A', '22386223-3', 'P√çA', 'IGNACIA', 'MARCHANT', 'MOR√ÅN'],
            ['4A', '22533366-1', 'MART√çN', 'ALAN VICENTE', 'QUINTANA', 'SAN'],
            ['4A', '22432358-1', 'CRISTOFER', 'BASTI√ÅN', 'RECABAL', 'Y√Å√ëEZ'],
            ['4A', '22293250-5', 'GABRIEL', 'ANTONIO', 'ROJAS', 'GONZ√ÅLEZ'],
            ['4A', '22451297-K', 'ESPERANZA', 'BEL√âN', 'TOLEDO', 'MU√ëOZ'],
            ['4A', '22665848-3', 'FRANCISCA', 'ALEJANDRA', 'Y√Å√ëEZ', 'GONZ√ÅLEZ'],
        ];
        // ==============================================================================

        // --- VARIABLES GLOBALES ---
        let groupedStudentsData = {}; // Datos para el generador (puede estar promocionado)
        let rawGroupedStudentsData = {}; // Datos para gesti√≥n (siempre 2025)
        let currentStudent = null; 

        // Elementos del Generador
        const yearSelect = document.getElementById('year-select');
        const courseSelect = document.getElementById('course-select');
        const studentSelect = document.getElementById('student-select');
        const buttonsSection = document.getElementById('certificate-buttons-section');
        const certificateContainer = document.getElementById('certificate-container');
        const certificateContent = document.getElementById('certificate-content');
        const printButton = document.getElementById('print-button');
        const regularCertButton = document.getElementById('generate-regular-cert');
        const matriculaCertButton = document.getElementById('generate-matricula-cert');
        const selectedStudentNameSpan = document.getElementById('selected-student-name');
        
        // Elementos de Gesti√≥n
        const tabGeneratorContent = document.getElementById('tab-content-generator');
        const tabManageContent = document.getElementById('tab-content-manage');
        const tabButtons = document.querySelectorAll('.tab-button');
        const deleteCourseSelect = document.getElementById('delete-course-select');
        const deleteStudentSelect = document.getElementById('delete-student-select');
        const deleteStudentButton = document.getElementById('delete-student-button');
        const addStudentButton = document.getElementById('add-student-button');
        const addMessage = document.getElementById('add-message');
        const deleteMessage = document.getElementById('delete-message');


        // --- FUNCIONES DE L√ìGICA DE PROMOCI√ìN ---
        
        /**
         * Calcula el curso promovido para el 2026.
         * Regla: Aumenta el n√∫mero en 1. Si es 4 o m√°s, retorna null (egresado).
         * Ej: "1A" -> "2A", "3C" -> "4C", "4A" -> null
         */
        function getPromotedCourse(currentCourse) {
            const match = currentCourse.match(/^(\d+)(.*)$/);
            if (!match) return currentCourse; // Si no sigue el patr√≥n n√∫mero+letra, se deja igual.

            const level = parseInt(match[1]);
            const letter = match[2];

            if (level >= 4) {
                return null; // Alumno egresa
            }

            // Calculo inicial
            let promotedCourse = (level + 1) + letter;

            // --- CORRECCI√ìN SOLICITADA ---
            // Si el curso calculado es 3B (que vendr√≠a del 2B), lo cambiamos forzosamente a 3C.
            if (promotedCourse === "3B") {
                promotedCourse = "3C";
            }

            return promotedCourse;
        }

        /**
         * Procesa la n√≥mina incrustada.
         * @param {boolean} applyPromotion - Si es true, aplica la l√≥gica de pasar de curso.
         */
        function processStudentData(applyPromotion = false) {
            const groupedData = {};

            RAW_STUDENT_DATA.forEach(fields => {
                // [0] Curso, [1] RUT, [2] Nombre1, [3] Nombre2, [4] ApellidoP, [5] ApellidoM
                if (fields.length < 6) return; 

                let course = String(fields[0]).trim().toUpperCase();
                const rut = String(fields[1]).trim().toUpperCase();

                if (!course || !rut) return;

                // Aplicar promoci√≥n si se solicita
                if (applyPromotion) {
                    course = getPromotedCourse(course);
                    if (!course) return; // Si retorna null (egresado), saltamos este alumno
                }

                // Filtrar valores falsy (como cadenas vac√≠as) antes de Mapear y Unir
                const names = [fields[2], fields[3]].filter(Boolean).map(s => String(s).trim().toUpperCase());
                const lastNames = [fields[4], fields[5]].filter(Boolean).map(s => String(s).trim().toUpperCase());

                const fullName = [...names, ...lastNames].join(' ');

                const student = { course, rut, firstName: names.join(' '), lastName: lastNames.join(' '), fullName };

                if (!groupedData[course]) {
                    groupedData[course] = [];
                }
                groupedData[course].push(student);
            });
            
            // Ordenar cursos y estudiantes
            const sortedGroupedData = {};
            Object.keys(groupedData).sort().forEach(key => {
                groupedData[key].sort((a, b) => a.fullName.localeCompare(b.fullName));
                sortedGroupedData[key] = groupedData[key];
            });
            
            return sortedGroupedData;
        }

        /**
         * Formatea la fecha actual.
         */
        function getFormattedDate(location) {
            const date = new Date();
            const day = date.getDate();
            const monthNames = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            
            return `${location}, ${day} de ${month} de ${year}.`;
        }

        /**
         * Genera el HTML para el certificado, incluyendo la marca de agua y el logo real.
         */
        function generateCertificateHTML(student, type) {
            const dateText = getFormattedDate(LOCATION);
            const selectedYear = yearSelect.value; // Obtener a√±o seleccionado
            
            let certificateTitle = '';
            let certificateBody = '';
            
            if (type === 'regular') {
                certificateTitle = 'CERTIFICADO DE ALUMNO REGULAR';
                certificateBody = `es alumno regular y se encuentra matriculado en ${student.course}, a√±o ${selectedYear}, de este establecimiento educacional.`;
            } else if (type === 'matricula') {
                certificateTitle = 'CERTIFICADO DE MATR√çCULA';
                // L√≥gica l√©xica: Si es 2026, decimos "se encuentra matriculado para el a√±o..."
                if (selectedYear === "2026") {
                    certificateBody = `ha sido aceptado y matriculado en el curso ${student.course} para el a√±o escolar ${selectedYear} en este establecimiento educacional.`;
                } else {
                    certificateBody = `se encuentra matriculado en ${student.course}, a√±o ${selectedYear}, de este establecimiento educacional.`;
                }
            } else {
                return '<p class="text-red-500">Error: Tipo de certificado no v√°lido.</p>';
            }
            
            // LOGO REAL (NO TOCAR RUTA - debe estar en la misma carpeta)
            const logoHTML = `
                <div class="text-center">
                    <img src="logo.jpg" alt="Logo Escuela" style="height: 80px; max-width: 80px;" class="mx-auto"/>
                </div>
            `;
            
            return `
                <div class="certificate-page p-8 sm:p-12 text-gray-800 leading-relaxed max-w-2xl mx-auto">
                    <div class="watermark">Desarrollado por ProfeAle</div>
                
                    <div class="flex justify-between items-center mb-10 text-xs">
                        <div class="text-left">
                            <p class="font-bold">Escuela Agr√≠cola Sagrados Corazones,</p>
                            <p>Corporaci√≥n Educacional Veloz Educa</p>
                        </div>
                        ${logoHTML}
                    </div>
                    
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-serif font-bold tracking-wider border-b-2 border-gray-900 inline-block pb-1 uppercase">${certificateTitle}</h2>
                    </div>

                    <div class="text-lg font-serif mb-10 text-justify">
                        <p class="indent-8 mb-4">
                            Quien suscribe, Director de la ${SCHOOL_NAME} de ${LOCATION}, ${DECREE},
                            <strong class="font-bold">CERTIFICA:</strong>
                        </p>
                        <p class="indent-8">
                            Que, don(a) <strong class="font-bold border-b border-dashed border-gray-500">${student.fullName}</strong>, 
                            Rut: <strong class="font-bold border-b border-dashed border-gray-500">${student.rut}</strong>
                            ${certificateBody}
                        </p>
                    </div>

                    <div class="text-lg font-serif mb-12 text-justify">
                        <p class="indent-8">
                            Se extiende el presente certificado a petici√≥n del interesado, y v√°lido para
                            los fines que estime conveniente.
                        </p>
                    </div>

                    <div class="text-center text-md font-serif mt-6 mb-20">
                        <p class="font-bold">${dateText}</p>
                    </div>
                    
                    <div class="text-center font-serif mt-8">
                        <div class="inline-block border-t-2 border-gray-900 pt-2 px-10">
                            <p class="font-bold text-lg">${DIRECTOR_NAME}</p>
                            <p class="text-md uppercase">${SCHOOL_NAME}</p>
                            <p class="text-sm">CORPORACI√ìN EDUCACIONAL VELOZ EDUCA</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- MANEJADORES GLOBALES ---

        /**
         * Inicializa los selectores del GENERADOR basados en el a√±o seleccionado.
         */
        function updateGeneratorSelectors() {
            const selectedYear = yearSelect.value;
            const applyPromotion = (selectedYear === "2026");
            
            groupedStudentsData = processStudentData(applyPromotion);
            
            populateCourses(courseSelect, groupedStudentsData);
            
            // Resetear selecci√≥n de alumno
            studentSelect.innerHTML = '<option value="" disabled selected>-- Seleccione un curso primero --</option>';
            studentSelect.disabled = true;
            buttonsSection.classList.add('hidden');
            certificateContainer.classList.add('hidden');
        }

        /**
         * Inicializa los selectores de GESTI√ìN (Siempre Base 2025).
         */
        function updateManagerSelectors() {
            rawGroupedStudentsData = processStudentData(false); // Nunca promueve en gesti√≥n
            populateCourses(deleteCourseSelect, rawGroupedStudentsData);
            
            deleteStudentSelect.innerHTML = '<option value="" disabled selected>-- Seleccione un curso --</option>';
            deleteStudentSelect.disabled = true;
            deleteStudentButton.disabled = true;
        }

        /**
         * Llena un selector de cursos dado un dataset.
         */
        function populateCourses(selectElement, dataSet) {
            const courses = Object.keys(dataSet).sort();
            selectElement.innerHTML = '<option value="" disabled selected>-- Elija un curso --</option>';
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                selectElement.appendChild(option);
            });
        }
        
        /**
         * Llena un selector de alumnos dado el selector de cursos y el dataset correcto.
         */
        function populateStudentsForSelector(courseSelector, studentSelector, dataSet, defaultMessage) {
            const selectedCourse = courseSelector.value;
            studentSelector.innerHTML = `<option value="" disabled selected>${defaultMessage}</option>`;
            studentSelector.disabled = true;
            
            if (selectedCourse && dataSet[selectedCourse]) {
                const students = dataSet[selectedCourse] || [];
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.rut; 
                    option.textContent = `${student.fullName} (RUT: ${student.rut})`;
                    studentSelector.appendChild(option);
                });
                studentSelector.disabled = false;
            }
        }


        // --- MANEJADORES DEL GENERADOR ---
        
        // Cuando cambia el a√±o, recargamos solo los selectores del generador
        yearSelect.addEventListener('change', () => {
            updateGeneratorSelectors();
        });

        function handleCourseChange() {
            currentStudent = null;
            buttonsSection.classList.add('hidden');
            certificateContainer.classList.add('hidden');

            populateStudentsForSelector(courseSelect, studentSelect, groupedStudentsData, '-- Seleccione un alumno --');
            
            studentSelect.classList.add('bg-white');
            studentSelect.classList.remove('bg-gray-100');
            regularCertButton.disabled = true;
            matriculaCertButton.disabled = true;
        }
        
        function handleStudentChange() {
            const selectedRut = studentSelect.value;
            const selectedCourse = courseSelect.value;
            certificateContainer.classList.add('hidden');
            
            if (selectedRut && selectedCourse) {
                currentStudent = groupedStudentsData[selectedCourse].find(s => s.rut === selectedRut);
                
                if (currentStudent) {
                    selectedStudentNameSpan.textContent = currentStudent.fullName;
                    regularCertButton.disabled = false;
                    matriculaCertButton.disabled = false;
                    buttonsSection.classList.remove('hidden');
                    return;
                }
            }
            
            currentStudent = null;
            buttonsSection.classList.add('hidden');
            regularCertButton.disabled = true;
            matriculaCertButton.disabled = true;
        }

        function handleCertificateGeneration(event) {
            if (!currentStudent) return;
            const type = event.currentTarget.getAttribute('data-type');
            const certificateHTML = generateCertificateHTML(currentStudent, type);
            certificateContent.innerHTML = certificateHTML;
            certificateContainer.classList.remove('hidden');
            certificateContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        function handlePrint() {
            window.print();
        }

        // --- MANEJADORES DE GESTI√ìN ---

        /**
         * Cambia la vista entre el generador y la gesti√≥n de alumnos.
         */
        function handleTabSwitch(event) {
            const targetTab = event.currentTarget.getAttribute('data-tab');
            
            tabButtons.forEach(btn => btn.classList.remove('active', 'bg-green-500', 'text-white'));
            event.currentTarget.classList.add('active', 'bg-green-500', 'text-white');

            if (targetTab === 'generator') {
                tabGeneratorContent.classList.remove('hidden');
                tabManageContent.classList.add('hidden');
                updateGeneratorSelectors(); // Refrescar por si hubo cambios en gesti√≥n
            } else if (targetTab === 'manage') {
                tabManageContent.classList.remove('hidden');
                tabGeneratorContent.classList.add('hidden');
                // Recargar selectores de gesti√≥n al entrar a la pesta√±a
                updateManagerSelectors();
                deleteMessage.textContent = '';
                addMessage.textContent = '';
            }
        }

        /**
         * Maneja el cambio de curso en la pesta√±a de eliminaci√≥n.
         */
        function handleDeleteCourseChange() {
            // Usamos rawGroupedStudentsData (datos sin promover)
            populateStudentsForSelector(deleteCourseSelect, deleteStudentSelect, rawGroupedStudentsData, '-- Seleccione un alumno --');
            deleteStudentButton.disabled = true;
            deleteMessage.textContent = '';
        }

        /**
         * Maneja la selecci√≥n de alumno en la pesta√±a de eliminaci√≥n.
         */
        function handleDeleteStudentChange() {
            deleteStudentButton.disabled = !deleteStudentSelect.value;
            deleteMessage.textContent = '';
        }

        /**
         * Maneja el evento de A√±adir Alumno.
         */
        function handleAddStudent() {
            const course = document.getElementById('new-course').value.trim().toUpperCase();
            const rut = document.getElementById('new-rut').value.trim().toUpperCase();
            const name1 = document.getElementById('new-name1').value.trim();
            const name2 = document.getElementById('new-name2').value.trim();
            const apellidoP = document.getElementById('new-apellidop').value.trim();
            const apellidoM = document.getElementById('new-apellidom').value.trim();

            if (!course || !rut || !name1 || !apellidoP || !apellidoM) {
                addMessage.textContent = '‚ùå Error: Complete Curso, RUT, Nombre y Apellidos.';
                addMessage.className = 'text-sm pt-1 text-red-500';
                return;
            }

            // A√±adir al array principal de datos
            RAW_STUDENT_DATA.push([course, rut, name1, name2, apellidoP, apellidoM]);

            addMessage.textContent = `‚úÖ Alumno ${name1.toUpperCase()} a√±adido al curso ${course} (N√≥mina 2025).`;
            addMessage.className = 'text-sm pt-1 text-green-500';

            // Limpiar campos
            document.querySelectorAll('#tab-content-manage input').forEach(input => input.value = '');
            
            // Recargar selectores en ambas pesta√±as
            updateManagerSelectors();
        }

        /**
         * Maneja el evento de Eliminar Alumno.
         */
        function handleDeleteStudent() {
            const rutToDelete = deleteStudentSelect.value;
            const studentFullName = deleteStudentSelect.options[deleteStudentSelect.selectedIndex].textContent.split(' (RUT:')[0];


            if (!rutToDelete) return;

            const initialLength = RAW_STUDENT_DATA.length;
            
            // Filtrar el array, manteniendo solo los que NO coinciden con el RUT
            for (let i = RAW_STUDENT_DATA.length - 1; i >= 0; i--) {
                if (String(RAW_STUDENT_DATA[i][1]).toUpperCase() === rutToDelete) {
                    RAW_STUDENT_DATA.splice(i, 1);
                    break; 
                }
            }

            if (RAW_STUDENT_DATA.length < initialLength) {
                deleteMessage.textContent = `‚úÖ Alumno ${studentFullName} eliminado correctamente.`;
                deleteMessage.className = 'text-sm pt-1 text-green-500';
            } else {
                deleteMessage.textContent = '‚ùå Error: No se encontr√≥ al alumno para eliminar.';
                deleteMessage.className = 'text-sm pt-1 text-red-500';
            }
            
            // Recargar selectores
            updateManagerSelectors();
        }

        // --- INICIALIZACI√ìN ---

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos iniciales
            updateGeneratorSelectors();
            updateManagerSelectors();
            
            document.getElementById('loading-message').classList.remove('hidden'); 

            // 1. Listeners para Generador de Certificados
            courseSelect.addEventListener('change', handleCourseChange);
            studentSelect.addEventListener('change', handleStudentChange);
            regularCertButton.addEventListener('click', handleCertificateGeneration);
            matriculaCertButton.addEventListener('click', handleCertificateGeneration);
            printButton.addEventListener('click', handlePrint);
            
            // 2. Listeners para Pesta√±as
            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabSwitch);
            });
            
            // 3. Listeners para Gesti√≥n de Alumnos
            addStudentButton.addEventListener('click', handleAddStudent);
            deleteCourseSelect.addEventListener('change', handleDeleteCourseChange);
            deleteStudentSelect.addEventListener('change', handleDeleteStudentChange);
            deleteStudentButton.addEventListener('click', handleDeleteStudent);
        });
    </script>
</body>
</html>