<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificados 2026 - Escuela Agr√≠cola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f3f4f6; }
        
        /* HOJA CARTA EST√ÅNDAR */
        .certificate-page { 
            position: relative; 
            width: 216mm; 
            min-height: 279mm; 
            padding: 25mm 20mm; 
            background: white;
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-size: 12pt; 
            line-height: 1.5;
        }
        
        /* SIN MARCA DE AGUA */
        
        .tab-button.active { background-color: #15803d; color: white; }
        
        /* IMPRESI√ìN LIMPIA */
        @media print {
            body * { visibility: hidden; }
            #certificate-container, #certificate-container * { visibility: visible; }
            #certificate-container { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; 
                border: none; box-shadow: none; 
            }
            .no-print { display: none !important; }
            @page { size: letter; margin: 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 font-sans">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden no-print">
        
        <header class="bg-green-800 text-white p-5 text-center shadow-md flex items-center justify-center gap-4">
            <img src="logo.jpg" alt="Logo" class="h-16 bg-white rounded-full p-1">
            <div>
                <h1 class="text-2xl font-bold font-sans">Generador de Certificados</h1>
                <p class="text-green-200 text-xs font-sans">Sistema Integrado de Gesti√≥n Escolar</p>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50">
            <button class="tab-button active flex-1 py-3 font-bold text-gray-600 hover:bg-green-50 transition font-sans" onclick="switchTab('generator')">
                üìÑ Emitir Documento
            </button>
            <button class="tab-button flex-1 py-3 font-bold text-gray-600 hover:bg-green-50 transition font-sans" onclick="switchTab('manage')">
                üë• Gesti√≥n y Datos
            </button>
        </div>

        <div id="tab-generator" class="p-6 sm:p-8 font-sans">
            <div class="bg-green-50 rounded-lg p-5 border border-green-100 mb-6 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-green-800 uppercase mb-1">1. A√±o Acad√©mico</label>
                        <select id="year-select" class="w-full p-2 border rounded font-bold text-green-900 text-sm" onchange="resetSelection()">
                            <option value="2025">2025 (Actual)</option>
                            <option value="2026" selected>2026 (Pr√≥ximo)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">2. Curso Base (2025)</label>
                        <select id="course-select" class="w-full p-2 border rounded text-sm" onchange="loadStudentsByCourse()">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">3. Estudiante</label>
                        <select id="student-select" class="w-full p-2 border rounded disabled:bg-gray-100 text-sm" disabled onchange="selectStudent()">
                            <option value="">‚Üê Seleccione curso</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="action-zone" class="hidden">
                <div class="flex items-center justify-between bg-white border border-gray-200 p-4 rounded-lg mb-6 shadow-sm">
                    <div>
                        <h3 class="text-md font-bold text-gray-800"><span id="display-name" class="text-green-700"></span></h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">RUT: <span id="display-rut" class="font-bold text-gray-700 bg-gray-100 px-2 py-0.5 rounded">--</span></p>
                    </div>
                    <div class="text-right">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">CURSO A CERTIFICAR</label>
                        <input type="text" id="final-course-input" class="w-20 text-center font-bold border-b border-green-500 focus:outline-none text-lg text-gray-800 bg-transparent" value="">
                    </div>
                </div>

                <div class="flex flex-wrap gap-3 justify-center">
                    <button onclick="generateCertificate('regular')" class="px-5 py-2.5 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 text-sm transition">
                        üéì Alumno Regular
                    </button>
                    <button onclick="generateCertificate('matricula')" class="px-5 py-2.5 bg-yellow-600 text-white font-bold rounded shadow hover:bg-yellow-700 text-sm transition">
                        üìù Certificado Matr√≠cula
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-manage" class="hidden p-6 sm:p-8 bg-gray-50 font-sans">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-md font-bold text-gray-800 mb-3">‚ûï Ingresar Alumno Nuevo</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="text-xs font-bold text-gray-500">Curso Actual</label><input type="text" id="new-course" placeholder="Ej: 1A" class="w-full p-2 border rounded uppercase text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500">RUT</label><input type="text" id="new-rut" placeholder="12345678-9" class="w-full p-2 border rounded uppercase text-sm"></div>
                    </div>
                    <div class="mb-3"><label class="text-xs font-bold text-gray-500">Nombre Completo (Apellidos Nombres)</label><input type="text" id="new-name" placeholder="PEREZ LOPEZ, JUAN" class="w-full p-2 border rounded uppercase text-sm"></div>
                    <button onclick="addStudentToDB()" class="w-full py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 text-sm">Guardar en Base de Datos</button>
                </div>

                <div class="bg-red-50 p-5 rounded-lg border border-red-200">
                    <h3 class="text-md font-bold text-red-800 mb-1">‚ö†Ô∏è Carga Masiva de N√≥mina</h3>
                    <p class="text-xs text-red-600 mb-3">Si los datos est√°n incompletos, usa este bot√≥n. <strong>Borrar√° todos los alumnos actuales</strong> y cargar√° la lista oficial completa con RUTs.</p>
                    <button onclick="fullDatabaseReset()" class="w-full py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 text-sm flex justify-center items-center gap-2">
                        üóëÔ∏è BORRAR Y CARGAR N√ìMINA OFICIAL (CON RUTS)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="certificate-container" class="hidden mt-8 mb-10 shadow-lg mx-auto w-fit">
        <div id="certificate-content"></div>
        <div class="no-print text-center py-4 bg-gray-100 border-t">
            <button onclick="window.print()" class="px-6 py-2 bg-gray-800 text-white font-bold rounded shadow hover:bg-black text-sm">
                üñ®Ô∏è Imprimir
            </button>
            <button onclick="document.getElementById('certificate-container').classList.add('hidden')" class="ml-4 px-4 py-2 text-gray-500 text-sm underline hover:text-red-500">
                Cerrar Vista
            </button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const firebaseConfig = { apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I", authDomain: "suspenciones-40d0c.firebaseapp.com", projectId: "suspenciones-40d0c", storageBucket: "suspenciones-40d0c.firebasestorage.app", messagingSenderId: "853418739042", appId: "1:853418739042:web:d051befb99cd2acdd4583b", measurementId: "G-L00J7XN6Y1" };
        
        // DATOS INSTITUCIONALES
        const SCHOOL_NAME = "Escuela Agr√≠cola Sagrados Corazones"; 
        const LOCATION = "Villa Alegre";
        const DIRECTOR_NAME = "MIGUEL D√çAZ JARA";
        const DECREE = "Decreto Cooperador de la funci√≥n Educacional del Estado N¬∞ 17.576 del 10 de septiembre de 1965";

        // N√ìMINA OFICIAL COMPLETA (NOMBRE + RUT) PARA CARGA MASIVA
        const NOMINA_OFICIAL = [{"curso": "2A", "nombre": "ALBURQUENQUE DEL GRECO, EMILYA ANTONIA", "rut": "23376817-0"}, {"curso": "2A", "nombre": "ANABAL√ìN BELTR√ÅN, BENJAM√çN NICOL√ÅS", "rut": "22922460-3"}, {"curso": "2A", "nombre": "CONTRERAS SALGADO, HADEEY ALEJANDRA", "rut": "23355953-9"}, {"curso": "2A", "nombre": "FERRADA ALBORNOZ, AGUST√çN ALEXIS", "rut": "23560082-K"}, {"curso": "2A", "nombre": "IB√Å√ëEZ GONZ√ÅLEZ, FERNANDA MAGDALENA", "rut": "23644472-4"}, {"curso": "2A", "nombre": "LAGOS LASTRA, ALEXANDRA DANAE", "rut": "23389072-3"}, {"curso": "2A", "nombre": "L√ìPEZ L√ìPEZ, LUCIANO ANTONIO", "rut": "23498596-5"}, {"curso": "2A", "nombre": "MALDONADO FLORES, ANTONELLA BEL√âN", "rut": "23396870-6"}, {"curso": "2A", "nombre": "MARIN MAR√çN, IGNACIO ANTONIO", "rut": "22793858-7"}, {"curso": "2A", "nombre": "MONTECINO D√çAZ, VALESKA BEL√âN", "rut": "23548214-2"}, {"curso": "2A", "nombre": "MU√ëOZ CONTRERAS, LUIS GABRIEL", "rut": "23366642-4"}, {"curso": "2A", "nombre": "MU√ëOZ LUNA, ROGER JOEL", "rut": "23622121-0"}, {"curso": "2A", "nombre": "NAVARRO VILLANUEVA, KARLA PAZ", "rut": "23329866-2"}, {"curso": "2A", "nombre": "ORELLANA ARRIAGADA, SEBASTI√ÅN ANDR√âS", "rut": "23388136-8"}, {"curso": "2A", "nombre": "QUEZADA NARANJO, FELIPE ALONSO", "rut": "23640108-1"}, {"curso": "2A", "nombre": "QUINTEROS VERGARA, FERNANDA FLORENCIA", "rut": "23529637-3"}, {"curso": "2A", "nombre": "RAM√çREZ VILLALOBOS, DUVAN EMILIO", "rut": "23534317-7"}, {"curso": "2A", "nombre": "SANTANDER L√ìPEZ, MAR√çA JOS√â", "rut": "23679554-3"}, {"curso": "2A", "nombre": "TAPIA CASTILLA, JEANFRANCO PATRICK", "rut": "23631475-8"}, {"curso": "2A", "nombre": "URBINA C√ÅCERES, FRANCHESCA POULETTE", "rut": "23007625-1"}, {"curso": "2A", "nombre": "V√ÅSQUEZ ZALDUENDO, AMANDA ISABEL", "rut": "23584521-0"}, {"curso": "2A", "nombre": "ZABALAGA COFR√â, DAMI√ÅN ANDR√âS", "rut": "23404221-1"}, {"curso": "2A", "nombre": "BAEZ DONOSO, LUKAS ALFONSO", "rut": "23461777-K"}, {"curso": "2A", "nombre": "MESA D√çAZ, GONZALO IGNACIO", "rut": "23032545-6"}, {"curso": "2A", "nombre": "ARAVENA Z√ö√ëIGA, NOEM√ç DE JES√öS DE LAS ESTRELLAS", "rut": "23367234-3"}, {"curso": "2A", "nombre": "ASTUDILLO CAMPOS, CRIST√ìBAL ANTONIO", "rut": "22826488-1"}, {"curso": "2A", "nombre": "ASTUDILLO V√ÅSQUEZ, BRUNO FERNANDO LE√ìN", "rut": "23251746-8"}, {"curso": "2A", "nombre": "CUMINAO VIDAL, CATALINA ANDREA", "rut": "23545428-9"}, {"curso": "2A", "nombre": "D√çAZ MALUENDA, MIGUEL ALBERTO", "rut": "23224652-9"}, {"curso": "2A", "nombre": "KILTAN GONZ√ÅLEZ, DIDIER EZEQUIEL", "rut": "23337375-3"}, {"curso": "2A", "nombre": "L√ìPEZ ACU√ëA, MARCO EMILIO", "rut": "23355954-7"}, {"curso": "2A", "nombre": "L√ìPEZ NOVOA, EYDAN DAMI√ÅN", "rut": "23153879-8"}, {"curso": "2A", "nombre": "M√âNDEZ SUAZO, FABI√ÅN FELIPE", "rut": "20760552-2"}, {"curso": "2A", "nombre": "MOYA REYES, MATEO ANTONIO BENJAM√çN", "rut": "23391772-9"}, {"curso": "2A", "nombre": "OSES CAMPOS, VALENTINA ABIGAIL", "rut": "23432193-5"}, {"curso": "2A", "nombre": "PALMA ORELLANA, ANTONELLA FRANCISCA", "rut": "23190411-5"}, {"curso": "2A", "nombre": "PEREIRA ORELLANA, MONSERRAT ALAMIRA", "rut": "23605196-K"}, {"curso": "2A", "nombre": "P√âREZ ORMAZ√ÅBAL, ZADKA ALEJANDRA", "rut": "23415461-3"}, {"curso": "2A", "nombre": "ROJAS GONZ√ÅLEZ, FLORENCIA TRINIDAD", "rut": "23290841-6"}, {"curso": "2A", "nombre": "ROJAS LEIVA, EDUARDO JAVIER", "rut": "23264828-7"}, {"curso": "2A", "nombre": "V√ÅSQUEZ AGUILERA, SCARLET NICOLE", "rut": "22763630-0"}, {"curso": "2A", "nombre": "Y√Å√ëEZ GONZ√ÅLEZ, BRAYAN DAMI√ÅN", "rut": "23616701-1"}, {"curso": "2A", "nombre": "VARGAS MORAGA, MARTINA SAYEN", "rut": "23555453-4"}, {"curso": "2A", "nombre": "SALAZAR SALAS, PEDRO JOS√â", "rut": "23301500-8"}, {"curso": "2A", "nombre": "VERA BRAVO, FLORENCIA ANTONIA", "rut": "23296637-8"}, {"curso": "2A", "nombre": "P√âREZ QUEVEDO, CONSTANZA TRINIDAD", "rut": "23479449-3"}, {"curso": "2A", "nombre": "RIQUELME SANTOS, BENJAM√çN ALONSO", "rut": "23112966-9"}, {"curso": "3A", "nombre": "AHUMADA ROJAS, TRINIDAD BEL√âN", "rut": "23006149-1"}, {"curso": "3A", "nombre": "ESPINOSA TORRES, FERNANDA ELENA", "rut": "23090163-5"}, {"curso": "3A", "nombre": "ESPINOZA PE√ëALILLO, BRAYAN JES√öS", "rut": "23236242-1"}, {"curso": "3A", "nombre": "GONZ√ÅLEZ SALAZAR, EMILIA CATALINA", "rut": "23121508-5"}, {"curso": "3A", "nombre": "MEDEL OJEDA, LE√ìN IGNACIO", "rut": "23132468-2"}, {"curso": "3A", "nombre": "MORALES REIM√ÅN, ALFONSO TOM√ÅS", "rut": "22617512-1"}, {"curso": "3A", "nombre": "PEREIRA HORMAZ√ÅBAL, MAXIMILIANO EDUARDO", "rut": "23054557-K"}, {"curso": "3A", "nombre": "PINTO TOBAR, JORD√ÅN AMARO", "rut": "23029359-7"}, {"curso": "3A", "nombre": "RECABAL Y√Å√ëEZ, KEVIN ANDR√âS", "rut": "23086976-6"}, {"curso": "3A", "nombre": "RIQUELME CASTILLO, MAT√çAS EDUARDO ANTONIO", "rut": "23284002-1"}, {"curso": "3A", "nombre": "RIVERA ABARZA, CONSTANZA VICTORIA", "rut": "23141589-0"}, {"curso": "3A", "nombre": "SANTIS CASSEUS, TEIVA SCARLETT", "rut": "23294557-5"}, {"curso": "3A", "nombre": "SOBARZO Y√âVENES, KATHERINNE ALEXIA BEL√âN", "rut": "22912548-6"}, {"curso": "3A", "nombre": "TOLEDO ALBORNOZ, ANTONELLA INES", "rut": "23209204-1"}, {"curso": "3A", "nombre": "VENEGAS ARRIAGADA, ANTONIA EDITH", "rut": "23115030-7"}, {"curso": "3A", "nombre": "VIELMA ZABALAGA, JOAN MANUEL", "rut": "23146366-6"}, {"curso": "3A", "nombre": "MEZA COLIM√ÅN, ANGEL BLAS", "rut": "23255825-3"}, {"curso": "3A", "nombre": "SAAVEDRA BRAVO, FLORENCIA ALEJANDRA", "rut": "23164383-4"}, {"curso": "3C", "nombre": "ARAYA DOM√çNGUEZ, ALEX FABI√ÅN", "rut": "22927087-7"}, {"curso": "3C", "nombre": "BRAVO MENARES, ALEX JOHAN", "rut": "23099931-7"}, {"curso": "3C", "nombre": "CARRASCO LEIVA, BENJAM√çN IGNACIO", "rut": "23200990-K"}, {"curso": "3C", "nombre": "CARVAJAL URRUTIA, CONSTANZA PRISILA (DANIEL)", "rut": "23086622-8"}, {"curso": "3C", "nombre": "ENCINA PIZARRO, DIEGO BENJAM√çN ALEXANDER", "rut": "23194660-8"}, {"curso": "3C", "nombre": "FA√öNDEZ NORAMBUENA, ALEJANDRO ANTONIO", "rut": "23229539-2"}, {"curso": "3C", "nombre": "JARAMILLO VILLAR, EMILIO SCOTT", "rut": "22827535-2"}, {"curso": "3C", "nombre": "L√ìPEZ VILLAR, MART√çN ALONSO", "rut": "23321258-K"}, {"curso": "3C", "nombre": "MIRANDA MU√ëOZ, ALEXANDRA JAVIERA", "rut": "23285276-3"}, {"curso": "3C", "nombre": "MU√ëOZ TRONCOSO, H√âCTOR ANTONIO", "rut": "22459961-7"}, {"curso": "3C", "nombre": "OLIVARES VALENZUELA, ALONSO IGNACIO", "rut": "23097156-0"}, {"curso": "3C", "nombre": "OLIVARES VALENZUELA, ANTONELLA DANAE IGNACIA", "rut": "22804086-K"}, {"curso": "3C", "nombre": "ORELLANA GARRIDO, MAT√çAS LEANDRO", "rut": "22876195-8"}, {"curso": "3C", "nombre": "PUNOY MEDEL, MILLARAY ANG√âLICA", "rut": "23113000-4"}, {"curso": "3C", "nombre": "QUI√ëENAO MU√ëOZ, CRIST√ìBAL PATRICIO", "rut": "23118361-2"}, {"curso": "3C", "nombre": "RIQUELME COLOMA, DALIA CONSTANZA", "rut": "23244598-K"}, {"curso": "3C", "nombre": "SALGADO ROJAS, VICENTE MOIS√âS", "rut": "23304433-4"}, {"curso": "3C", "nombre": "SANDOVAL CERPA, VICENTE ESTEBAN", "rut": "22922664-9"}, {"curso": "3C", "nombre": "SOTO NARANJO, CHRISTOPHER", "rut": "23230279-8"}, {"curso": "3C", "nombre": "VEKARIC VERDEJO, MART√çN", "rut": "22907717-1"}, {"curso": "4A", "nombre": "ALC√ÅNTAR GARC√çA, MARTINA ALEJANDRA", "rut": "22717035-2"}, {"curso": "4A", "nombre": "BAHAMONDE MU√ëOZ, ARIEL LEON", "rut": "22202028-K"}, {"curso": "4A", "nombre": "CAMPOS MU√ëOZ, CRISTOPHER JES√öS", "rut": "22932851-4"}, {"curso": "4A", "nombre": "CANCINO OR√ìSTICA, VICENTE GASPAR", "rut": "22587064-0"}, {"curso": "4A", "nombre": "CARRASCO GONZ√ÅLEZ, CAMILA ANDREA", "rut": "22935345-4"}, {"curso": "4A", "nombre": "COFR√â CASTILLO, ANTONIO ANDR√âS", "rut": "22852052-7"}, {"curso": "4A", "nombre": "CONTRERAS VENEGAS, BEL√âN ALEJANDRA", "rut": "22542992-8"}, {"curso": "4A", "nombre": "GALDAMES VERGARA, FELIPE ESTEBAN", "rut": "22897408-0"}, {"curso": "4A", "nombre": "GARC√çA GONZ√ÅLEZ, SANTIAGO HUMBERTO", "rut": "22152106-4"}, {"curso": "4A", "nombre": "GONZ√ÅLEZ AMIGO, FRANCISCA IGNACIA", "rut": "22820588-5"}, {"curso": "4A", "nombre": "GONZ√ÅLEZ SALAZAR, JOAQU√çN ALONSO", "rut": "22565627-4"}, {"curso": "4A", "nombre": "GUTI√âRREZ GUTI√âRREZ, ANGEL MART√çN", "rut": "22808692-4"}, {"curso": "4A", "nombre": "MART√çNEZ LIZANA, AARON ALEJANDRO", "rut": "22970003-0"}, {"curso": "4A", "nombre": "MEZA CARRASCO, BENJAM√çN INTI", "rut": "22482618-4"}, {"curso": "4A", "nombre": "MI√ëO GONZALEZ, CATALINA ANDREA", "rut": "22858572-6"}, {"curso": "4A", "nombre": "MORAGA PACHECO, RENATO IGNACIO", "rut": "22932822-0"}, {"curso": "4A", "nombre": "P√âREZ COR√ìN, MANUEL IGNACIO", "rut": "22839912-4"}, {"curso": "4A", "nombre": "SAMANIEGO CORTEZ, JAKSON FERGIE", "rut": "100710921-7"}, {"curso": "4A", "nombre": "SEP√öLVEDA SALAZAR, SOF√çA ANTONIA", "rut": "22889391-9"}, {"curso": "4A", "nombre": "TAPIA ACU√ëA, GABRIEL ANTONIO", "rut": "22709426-5"}, {"curso": "4A", "nombre": "VEGA VIVANCO, CRIST√ìBAL ANTONIO", "rut": "23022549-4"}, {"curso": "4A", "nombre": "VERA NAVARRETE, DANIELA ELIZABETH", "rut": "22903476-6"}, {"curso": "4A", "nombre": "VILLALOBOS ARAVENA, KARINA ANGELINA", "rut": "22792420-9"}, {"curso": "4A", "nombre": "VILLALOBOS VILLALOBOS, SAMIR LUCIAN JESUS", "rut": "22733377-4"}, {"curso": "4A", "nombre": "HERN√ÅNDEZ SEP√öLVEDA, VICENTE ALEJANDRO", "rut": "22644932-9"}, {"curso": "4A", "nombre": "TORREALBA MOYA, FLORVELIS DE LOS ANGELES", "rut": "100793606-7"}, {"curso": "4A", "nombre": "CARO URRUTIA, CONSUELO ANTONIA", "rut": "23038091-0"}, {"curso": "4A", "nombre": "LOBOS C√ÅCERES, ANTONIA PAZ", "rut": "22448022-9"}, {"curso": "4C", "nombre": "ARELLANO ACU√ëA, MART√çN ANTONIO", "rut": "22558171-1"}, {"curso": "4C", "nombre": "AROS √ÅVILA, DAYANA IGNACIA", "rut": "22897577-K"}, {"curso": "4C", "nombre": "CABRERA COLOMBINO, MAR√çA GRACIA", "rut": "22339310-1"}, {"curso": "4C", "nombre": "FUENTES CARRASCO, YARIXA ALEJANDRA", "rut": "22865819-7"}, {"curso": "4C", "nombre": "G√ìMEZ CANCINO, DANIELA ALEJANDRA", "rut": "22971225-K"}, {"curso": "4C", "nombre": "GUTI√âRREZ CARRI√ìN, MILLARAY CAROLINA", "rut": "22698950-1"}, {"curso": "4C", "nombre": "HONORATO TAPIA, GLORIA JAVIERA", "rut": "22665539-5"}, {"curso": "4C", "nombre": "LARA RIVERA, BENJAM√çN ESTEBAN", "rut": "22907525-K"}, {"curso": "4C", "nombre": "PALACIOS SOTO, JOS√â TOM√ÅS", "rut": "22801082-0"}, {"curso": "4C", "nombre": "PEZO SANTANDER, JOS√â CRIST√ìBAL", "rut": "22477831-7"}, {"curso": "4C", "nombre": "ROCHA ROJAS, JOS√â PABLO WILLIAMS", "rut": "22796354-9"}, {"curso": "4C", "nombre": "ROJAS Y√âVENES, FABIANA ISIDORA", "rut": "22876139-7"}, {"curso": "4C", "nombre": "S√ÅNCHEZ PAREJA, ANDY ANTONIO", "rut": "22916573-9"}, {"curso": "4C", "nombre": "SANTANDER L√ìPEZ, SIM√ìN ESTEBAN", "rut": "22845486-9"}, {"curso": "4C", "nombre": "TRONCOSO LIZAMA, SIOMARA IGNACIA", "rut": "23004590-9"}, {"curso": "4C", "nombre": "WARNKEN ROJAS, LUCIANA BERNABELA", "rut": "23009921-9"}, {"curso": "4C", "nombre": "DE LA HOZ VALENZUELA, FRANCO SEBASTI√ÅN", "rut": "22783846-9"}, {"curso": "4C", "nombre": "COLLAO MEDINA, ANA√çS VALENTINA", "rut": "23048274-8"}];

        let db, ALL_STUDENTS = [], CURRENT_STUDENT = null;

        window.addEventListener('load', async () => {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await loadStudentsFromDB();
            } catch (e) { Swal.fire('Error', 'No se pudo conectar a la base de datos.', 'error'); }
        });

        async function loadStudentsFromDB() {
            ALL_STUDENTS = [];
            const courseSelect = document.getElementById('course-select');
            courseSelect.innerHTML = '<option>Cargando...</option>';
            try {
                const snap = await db.collection("alumnos").get();
                snap.forEach(doc => { ALL_STUDENTS.push({ id: doc.id, ...doc.data() }); });
                ALL_STUDENTS.sort((a, b) => a.nombre.localeCompare(b.nombre));
                populateCourseSelect();
            } catch (e) { console.error(e); courseSelect.innerHTML = '<option>Error</option>'; }
        }

        function populateCourseSelect() {
            const select = document.getElementById('course-select');
            const courses = [...new Set(ALL_STUDENTS.map(s => s.curso))].sort();
            select.innerHTML = '<option value="">-- Seleccione Curso --</option>';
            courses.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
        }

        window.loadStudentsByCourse = function() {
            const course = document.getElementById('course-select').value;
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">-- Seleccione Alumno --</option>';
            select.disabled = true;
            document.getElementById('action-zone').classList.add('hidden');
            if (course) {
                const filtered = ALL_STUDENTS.filter(s => s.curso === course);
                filtered.forEach(s => select.innerHTML += `<option value="${s.id}">${s.nombre}</option>`);
                select.disabled = false;
            }
        };

        window.selectStudent = function() {
            const id = document.getElementById('student-select').value;
            if (!id) { document.getElementById('action-zone').classList.add('hidden'); return; }
            CURRENT_STUDENT = ALL_STUDENTS.find(s => s.id === id);
            
            document.getElementById('display-name').innerText = CURRENT_STUDENT.nombre;
            const rut = CURRENT_STUDENT.rut || "SIN DATOS";
            document.getElementById('display-rut').innerText = rut;
            document.getElementById('display-rut').className = rut === "SIN DATOS" ? "font-bold text-red-500 bg-red-100 px-2 py-0.5 rounded" : "font-bold text-gray-700 bg-gray-100 px-2 py-0.5 rounded";
            
            const year = document.getElementById('year-select').value;
            let finalCourse = CURRENT_STUDENT.curso;
            if (year === "2026") finalCourse = getPromotedCourse(finalCourse);
            
            document.getElementById('final-course-input').value = finalCourse || "Egresado";
            document.getElementById('action-zone').classList.remove('hidden');
        };

        function getPromotedCourse(current) {
            const match = current.match(/^(\d+)(.*)$/);
            if (!match) return current;
            let num = parseInt(match[1]);
            let letter = match[2];
            if (num >= 4) return "Egresado"; 
            let nextNum = num + 1;
            let nextCourse = nextNum + letter;
            if(nextCourse === "3B") nextCourse = "3C"; 
            return nextCourse;
        }

        window.generateCertificate = function(type) {
            if (!CURRENT_STUDENT) return;
            const year = document.getElementById('year-select').value;
            const finalCourse = document.getElementById('final-course-input').value;
            const dateText = getFormattedDate();
            
            let title = type === 'regular' ? "CERTIFICADO DE ALUMNO REGULAR" : "CERTIFICADO DE MATR√çCULA";
            let body = type === 'regular' 
                ? `es alumno regular y se encuentra matriculado en el curso <strong>${finalCourse}</strong>, a√±o escolar <strong>${year}</strong>, de este establecimiento educacional.`
                : (year === "2026" 
                    ? `ha sido aceptado y matriculado en el curso <strong>${finalCourse}</strong> para el a√±o escolar <strong>${year}</strong> en este establecimiento.`
                    : `se encuentra matriculado en el curso <strong>${finalCourse}</strong>, a√±o <strong>${year}</strong>.`);

            const html = `
                <div class="certificate-page">
                    <div class="flex justify-between items-start mb-6">
                        <div class="text-[10pt] leading-tight">
                            <p class="font-bold uppercase">${SCHOOL_NAME}</p>
                            <p>${LOCATION}</p>
                        </div>
                        <img src="logo.jpg" alt="Logo" style="height: 70px;">
                    </div>

                    <div class="text-center mb-8 mt-4">
                        <h2 class="text-2xl font-bold uppercase border-b-2 border-black inline-block pb-1">${title}</h2>
                    </div>

                    <div class="text-[12pt] leading-normal text-justify mb-8">
                        <p class="mb-4">
                            Quien suscribe, Director de la ${SCHOOL_NAME}, ${DECREE}, <strong>CERTIFICA</strong>:
                        </p>
                        <p class="mb-4 indent-8">
                            Que, don(a) <strong class="uppercase">${CURRENT_STUDENT.nombre}</strong>, 
                            RUT <strong>${CURRENT_STUDENT.rut || "______________"}</strong>, ${body}
                        </p>
                        <p class="indent-8">
                            Se extiende el presente certificado a petici√≥n del interesado para los fines que estime conveniente.
                        </p>
                    </div>

                    <div class="text-right mt-12 text-[12pt]">
                        <p>${dateText}</p>
                    </div>

                    <div class="mt-28 text-center">
                        <div class="inline-block border-t border-black pt-2 px-12">
                            <p class="font-bold text-lg">${DIRECTOR_NAME}</p>
                            <p class="uppercase text-xs tracking-wider">Director</p>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-4 left-0 w-full text-center text-[9px] text-gray-400 no-print">
                        Plataforma Gesti√≥n 2026 ‚Ä¢ Desarrollado por ProfeAle
                    </div>
                </div>
            `;
            document.getElementById('certificate-content').innerHTML = html;
            document.getElementById('certificate-container').classList.remove('hidden');
            document.getElementById('certificate-container').scrollIntoView({behavior: 'smooth'});
        };

        // --- FUNCI√ìN DE RESET TOTAL (CARGA DE N√ìMINA) ---
        window.fullDatabaseReset = async function() {
            if(!confirm("‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øEst√°s seguro de BORRAR TODOS los alumnos actuales y volver a cargar la n√≥mina oficial completa (con RUTs)?\n\nEsto solucionar√° los problemas de datos faltantes.")) return;
            
            Swal.fire({title: 'Restaurando Base de Datos...', text: 'Borrando registros antiguos...', didOpen: () => Swal.showLoading()});
            
            try {
                // 1. Borrar todo por lotes
                const snap = await db.collection("alumnos").get();
                let batch = db.batch();
                let count = 0;
                
                for (const doc of snap.docs) {
                    batch.delete(doc.ref);
                    count++;
                    if (count >= 100) { await batch.commit(); batch = db.batch(); count = 0; }
                }
                if (count > 0) await batch.commit();

                // 2. Insertar n√≥mina oficial
                Swal.update({ text: 'Cargando n√≥mina oficial...' });
                let batchInsert = db.batch();
                let insertCount = 0;
                
                for (const student of NOMINA_OFICIAL) {
                    const ref = db.collection("alumnos").doc();
                    batchInsert.set(ref, student);
                    insertCount++;
                    if (insertCount >= 100) { await batchInsert.commit(); batchInsert = db.batch(); insertCount = 0; }
                }
                if (insertCount > 0) await batchInsert.commit();

                await loadStudentsFromDB();
                Swal.fire('¬°Base de Datos Restaurada!', 'Se han cargado 131 alumnos con sus RUTs correctamente.', 'success');
            } catch(e) {
                console.error(e);
                Swal.fire('Error', 'Hubo un problema durante la restauraci√≥n.', 'error');
            }
        };

        window.addStudentToDB = async function() {
            const course = document.getElementById('new-course').value.toUpperCase().trim();
            const name = document.getElementById('new-name').value.toUpperCase().trim();
            const rut = document.getElementById('new-rut').value.toUpperCase().trim();
            if (!course || !name) { Swal.fire('Error', 'Faltan datos', 'warning'); return; }
            await db.collection("alumnos").add({ nombre: name, curso: course, rut: rut });
            Swal.fire('Listo', 'Alumno guardado', 'success');
            loadStudentsFromDB();
        };

        function getFormattedDate() {
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const d = new Date();
            return `${LOCATION}, ${d.getDate()} de ${months[d.getMonth()]} de ${d.getFullYear()}`;
        }
        
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-generator').classList.add('hidden');
            document.getElementById('tab-manage').classList.add('hidden');
            document.getElementById('tab-' + tab).classList.remove('hidden');
        };
        
        window.resetSelection = function() {
            document.getElementById('action-zone').classList.add('hidden');
            document.getElementById('certificate-container').classList.add('hidden');
            if (CURRENT_STUDENT) selectStudent();
        }
    </script>
</body>
</html>